{% extends "frontend/base.html" %}

{% block extra_css %}
<style>
    /* Typography uses theme.css */

    h6 {
        font-weight: 600;
        letter-spacing: 0.3px;
        font-size: 1.1rem;
    }

    /* Colors now use design system from theme.css */

    #cashflowTableContainer {
        overflow: auto;
        border: 1px solid var(--border-color);
    }

    /* Remove spinner arrows from number inputs */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type="number"], input[type="text"], input[type="date"], select {
        -moz-appearance: textfield;
        appearance: textfield;
        font-size: 14px;
    }

    /* Enhanced input styling */
    .form-control:focus, .form-select:focus {
        border-color: var(--schema-cyan);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
        outline: none;
    }

    .form-control, .form-select {
        border: 1px solid var(--border-color);
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: all 0.15s ease;
        font-size: 14px;
    }

    .form-control:hover, .form-select:hover {
        border-color: var(--schema-cyan);
    }

    /* Month header with dates */
    .month-header {
        text-align: center;
        font-size: 0.7rem;
        line-height: 1.2;
    }
    .month-number {
        font-weight: 600;
        color: var(--text-primary);
        display: block;
    }
    .month-date {
        color: var(--text-secondary);
        font-size: 0.65rem;
        display: block;
    }

    /* Performance metrics cards - using theme system */
    .metric-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 16px;
        transition: all var(--transition-base);
    }

    .metric-card:hover {
        border-color: var(--schema-cyan);
        box-shadow: var(--shadow-md);
    }

    .metric-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 500;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.2;
    }

    .metric-value.positive {
        color: var(--success);
    }

    .metric-value.negative {
        color: var(--danger);
    }

    /* Card headers - MODERN CLEAN STYLE */
    .card-header {
        font-weight: 600;
        letter-spacing: 0.3px;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .card-header:hover {
        background: var(--bg-tertiary, var(--bg-secondary));
    }

    /* Compact spacing for inputs */
    .compact-form .mb-3 {
        margin-bottom: 0.75rem !important;
    }

    .compact-form .form-label {
        margin-bottom: 0.25rem !important;
        font-size: 0.85rem;
    }

    .compact-form .form-control,
    .compact-form .form-select {
        padding: 0.375rem 0.5rem;
        font-size: 0.9rem;
    }

    /* Compact metrics */
    .metric-card-compact {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 10px;
        transition: all 0.2s ease;
    }

    .metric-card-compact:hover {
        border-color: var(--schema-cyan);
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .metric-label-compact {
        font-size: 0.7rem;
        color: var(--text-secondary);
        font-weight: 600;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .metric-value-compact {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1.2;
    }

    /* Table section headers - CLEAN MODERN with full-width background */
    .table-secondary td,
    .table-secondary th {
        background: var(--slate-200, #e2e8f0) !important;
        color: var(--text-primary) !important;
        border-color: var(--slate-300, #cbd5e1) !important;
    }

    [data-theme="dark"] .table-secondary td,
    [data-theme="dark"] .table-secondary th {
        background: var(--slate-700, #334155) !important;
        color: var(--text-primary) !important;
    }

    /* Section header rows span full width */
    .table-secondary td[colspan] {
        background: var(--slate-200, #e2e8f0) !important;
    }

    [data-theme="dark"] .table-secondary td[colspan] {
        background: var(--slate-700, #334155) !important;
    }

    .table-secondary .btn-outline-secondary {
        border-color: var(--border-color);
        color: var(--text-secondary);
        font-size: 0.7rem;
        padding: 0.1rem 0.4rem;
    }

    .table-secondary .btn-outline-secondary:hover {
        background: var(--bg-primary);
        border-color: var(--schema-cyan);
        color: var(--schema-cyan);
    }

    /* Table dark header - MODERN with white borders */
    .table-dark th {
        background: var(--schema-navy, #0f172a) !important;
        color: #ffffff !important;
        border-color: rgba(255,255,255,0.3) !important;
        border-width: 1px !important;
    }

    .table-dark .month-header {
        color: #ffffff !important;
    }

    .table-dark .month-number {
        color: #ffffff !important;
    }

    .table-dark .month-date {
        color: rgba(255,255,255,0.7) !important;
    }

    /* Month header row - also dark to match */
    #monthHeaderRow th {
        background: var(--schema-navy, #0f172a) !important;
        color: #ffffff !important;
        border-color: rgba(255,255,255,0.3) !important;
    }

    /* Innovative sticky summary bar */
    .sticky-summary {
        position: sticky;
        top: 0;
        z-index: 99;
        background: var(--bg-primary);
        box-shadow: var(--shadow-sm);
        padding: 8px 16px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        border-bottom: 2px solid var(--schema-cyan);
    }

    .summary-item {
        text-align: center;
        flex: 1;
    }

    .summary-item-label {
        font-size: 0.65rem;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
    }

    .summary-item-value {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Status indicators */
    .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
    }

    .status-positive { background: var(--success); }
    .status-negative { background: var(--danger); }
    .status-neutral { background: var(--slate-400, #94a3b8); }

    /* Compact Header Bar - Modern Glass Effect */
    .compact-header-bar {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 12px 20px;
        box-shadow: var(--shadow-sm);
    }

    .project-name-input {
        font-weight: 600;
        width: 180px;
        border: 2px solid transparent;
        background: var(--bg-secondary);
        border-radius: 8px;
        transition: all 0.2s ease;
        color: var(--text-primary);
    }

    .project-name-input:focus {
        border-color: var(--schema-cyan);
        background: var(--bg-primary);
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    /* Inline Metrics - Modern Pill Style */
    .inline-metric {
        display: flex;
        align-items: center;
        gap: 6px;
        background: var(--bg-secondary);
        padding: 6px 12px;
        border-radius: 20px;
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .inline-metric:hover {
        box-shadow: var(--shadow-sm);
        border-color: var(--schema-cyan);
    }

    .inline-metric-label {
        font-size: 0.65rem;
        color: var(--text-secondary);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .inline-metric-input {
        width: 70px;
        text-align: right;
        font-weight: 600;
        padding: 2px 6px;
        font-size: 0.85rem;
        border: none;
        background: transparent;
        border-radius: 6px;
        color: var(--text-primary);
    }

    .inline-metric-input:focus {
        background: var(--bg-primary);
        outline: 2px solid var(--schema-cyan);
        outline-offset: -2px;
    }

    .inline-metric-unit {
        font-size: 0.65rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    /* Performance Metrics Bar - CLEAN MODERN */
    .metrics-bar {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px 24px;
        box-shadow: var(--shadow-sm);
    }

    .metrics-bar-inner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
    }

    .metric-item {
        text-align: center;
        flex: 1;
        min-width: 90px;
        padding: 8px 12px;
        background: var(--bg-primary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .metric-item:hover {
        border-color: var(--schema-cyan);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    .metric-item-label {
        display: block;
        font-size: 0.6rem;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 4px;
    }

    .metric-item-value {
        display: block;
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .metric-item-value.positive { color: var(--success); }
    .metric-item-value.negative { color: var(--danger); }

    /* AI Assist Button - SUBTLE, HIGHLIGHT ON HOVER */
    .ai-assist-btn {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        width: 22px;
        height: 18px;
        border-radius: 4px;
        font-size: 0.55rem;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        letter-spacing: -0.5px;
    }

    .ai-assist-btn:hover {
        background: var(--schema-cyan);
        border-color: var(--schema-cyan);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
    }

    /* Notes Button - CLEAN SVG ICON */
    .notes-btn {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        width: 22px;
        height: 18px;
        border-radius: 4px;
        font-size: 0.55rem;
        cursor: pointer;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .notes-btn:hover {
        background: var(--slate-100, #f1f5f9);
        border-color: var(--schema-cyan);
        color: var(--schema-cyan);
    }

    .notes-btn.has-notes {
        background: rgba(14, 165, 233, 0.1);
        border-color: var(--schema-cyan);
        color: var(--schema-cyan);
    }

    /* Notes icon SVG */
    .notes-btn svg {
        width: 10px;
        height: 10px;
    }

    /* Run AI All Button - SUBTLE */
    .ai-all-btn {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        font-size: 0.7rem;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .ai-all-btn:hover {
        background: var(--schema-cyan);
        border-color: var(--schema-cyan);
        color: white;
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }

    .ai-all-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Cost Item Cell */
    .cost-item-cell {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 4px;
    }

    .cost-item-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-primary);
    }

    .action-buttons {
        display: flex;
        gap: 2px;
        align-items: center;
    }

    /* Cashflow row styling */
    .cashflow-row td {
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .cashflow-row:hover td {
        background: var(--bg-secondary);
    }

    /* Card styling */
    .card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
    }

    /* Table styling */
    .table-bordered {
        border-color: var(--border-color);
    }

    .table-bordered td,
    .table-bordered th {
        border-color: var(--border-color);
    }

    /* Ensure all cells in a colored row get the same background */
    .cashflow-row.row-positive td {
        background-color: #d4edda !important;
    }

    .cashflow-row.row-negative td {
        background-color: #f8d7da !important;
    }

    .cashflow-row.row-neutral td {
        background-color: #fff3cd !important;
    }

    /* Dark mode adjustments for colored cells */
    [data-theme="dark"] .cashflow-row.row-positive td {
        background-color: rgba(34, 197, 94, 0.2) !important;
        color: #86efac !important;
    }

    [data-theme="dark"] .cashflow-row.row-negative td {
        background-color: rgba(239, 68, 68, 0.2) !important;
        color: #fca5a5 !important;
    }

    [data-theme="dark"] .cashflow-row.row-neutral td {
        background-color: rgba(234, 179, 8, 0.2) !important;
        color: #fde047 !important;
    }

    /* Dark mode cell colors */
    [data-theme="dark"] .cashflow-cell {
        color: var(--text-primary) !important;
    }

    /* Sticky column backgrounds for dark mode */
    [data-theme="dark"] .cashflow-row td[style*="position: sticky"] {
        background: var(--bg-primary) !important;
    }

    /* Notes modal dark mode */
    [data-theme="dark"] .notes-workings-area {
        background: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    [data-theme="dark"] .notes-section {
        border-color: var(--border-color);
    }

    [data-theme="dark"] .notes-section-header {
        background: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    /* AI research panel dark mode */
    [data-theme="dark"] .ai-research-panel {
        background: var(--bg-secondary);
        border-color: var(--border-color);
    }

    [data-theme="dark"] .ai-research-header {
        border-color: var(--border-color);
    }

    /* Residual land bar dark mode */
    [data-theme="dark"] .residual-land-bar {
        background: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
    }

    /* Modal dark mode */
    [data-theme="dark"] .modal-content {
        background: var(--bg-primary);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    [data-theme="dark"] .modal-header {
        border-color: var(--border-color);
    }

    [data-theme="dark"] .modal-footer {
        border-color: var(--border-color);
    }

    /* Inline style overrides for sticky columns */
    .cashflow-row td:first-child {
        background: var(--bg-primary) !important;
    }

    [data-theme="dark"] .cashflow-row td:first-child {
        background: var(--bg-primary) !important;
    }
    /* Individual cell colors */
    .cell-positive {
        background-color: #d4edda !important;
    }

    .cell-negative {
        background-color: #f8d7da !important;
    }

    .cell-neutral {
        background-color: #fff3cd !important;
    }

    [data-theme="dark"] .cell-positive {
        background-color: rgba(34, 197, 94, 0.25) !important;
    }

    [data-theme="dark"] .cell-negative {
        background-color: rgba(239, 68, 68, 0.25) !important;
    }

    [data-theme="dark"] .cell-neutral {
        background-color: rgba(234, 179, 8, 0.25) !important;
    }


    /* Fix inline style backgrounds for dark mode */
    [data-theme="dark"] td[style*="background: var(--bg-primary)"] {
        background: var(--bg-primary) !important;
    }

    [data-theme="dark"] td[style*="background: white"] {
        background: var(--bg-primary) !important;
    }

    /* Ensure table text is readable in both modes */
    .table td, .table th {
        color: var(--text-primary);
    }

    /* Fix the default cell background */
    .cashflow-cell {
        background-color: var(--bg-primary);
        color: var(--text-primary);
    }

    [data-theme="dark"] .cashflow-cell {
        background-color: var(--bg-primary);
    }

    /* Fix f8f9fa cells for dark mode */
    [data-theme="dark"] td[style*="background-color: rgb(248, 249, 250)"],
    [data-theme="dark"] td[style*="background-color: #f8f9fa"] {
        background-color: var(--bg-primary) !important;
    }


    /* Notes Modal Styling */
    .notes-modal .modal-dialog {
        max-width: 800px;
    }

    .notes-workings-area {
        min-height: 300px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        line-height: 1.5;
        background: #fafafa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }

    .notes-section {
        border: 1px solid #e9ecef;
        border-radius: 6px;
        margin-bottom: 10px;
    }

    .notes-section-header {
        background: #f8f9fa;
        padding: 8px 12px;
        font-weight: 600;
        font-size: 0.85rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .notes-section-body {
        padding: 10px 12px;
    }

    /* AI Research Panel */
    .ai-research-panel {
        background: linear-gradient(135deg, #f8f9ff 0%, #fff8f8 100%);
        border: 1px solid #e0e4ff;
        border-radius: 8px;
        padding: 15px;
    }

    .ai-research-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e4ff;
    }

    .ai-research-header .ai-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .ai-benchmark-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
    }

    .ai-benchmark-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 10px;
        text-align: center;
    }

    .ai-benchmark-label {
        font-size: 0.7rem;
        color: #6c757d;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .ai-benchmark-value {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-primary));
    }

    .ai-benchmark-source {
        font-size: 0.65rem;
        color: #adb5bd;
        margin-top: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Compact Top Bar: Project Info + Metrics in single row -->
    <div class="compact-header-bar mb-2">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <!-- Project Name & Scenario Controls -->
            <div class="d-flex align-items-center gap-2">
                <input type="text" class="form-control form-control-sm project-name-input" id="project_name" value="New Development" placeholder="Project Name">
                <input type="date" class="form-control form-control-sm" id="start_date" value="2025-01-01" style="width: 130px;">
                <select class="form-select form-select-sm" id="currency" style="width: 85px;">
                    <option value="AUD" selected>AUD</option>
                    <option value="USD">USD</option>
                    <option value="GBP">GBP</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>

            <!-- Key Building Metrics - Inline -->
            <div class="d-flex align-items-center gap-2 building-metrics-inline">
                <div class="inline-metric">
                    <span class="inline-metric-label">Site</span>
                    <input type="number" class="form-control form-control-sm inline-metric-input" id="site_area" value="650">
                    <span class="inline-metric-unit">m¬≤</span>
                </div>
                <div class="inline-metric">
                    <span class="inline-metric-label">GFA</span>
                    <input type="number" class="form-control form-control-sm inline-metric-input" id="gfa" value="975" step="0.1">
                    <span class="inline-metric-unit">m¬≤</span>
                </div>
                <div class="inline-metric">
                    <span class="inline-metric-label">NSA</span>
                    <input type="number" class="form-control form-control-sm inline-metric-input bg-light" id="nsa" readonly value="829">
                    <span class="inline-metric-unit">m¬≤</span>
                </div>
                <div class="inline-metric">
                    <span class="inline-metric-label">Units</span>
                    <input type="number" class="form-control form-control-sm inline-metric-input" id="num_units" value="10" style="width: 50px;">
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#advancedMetricsCollapse" title="More settings">
                    <i class="bi bi-gear"></i> More
                </button>
            </div>

            <!-- Scenario Controls -->
            <div class="d-flex align-items-center gap-1 ms-auto scenario-controls">
                <input type="text" class="form-control form-control-sm" id="scenarioName" placeholder="Scenario" style="width: 100px;">
                <button type="button" class="btn btn-sm btn-success" id="saveScenarioBtn" title="Save">üíæ</button>
                <select class="form-select form-select-sm" id="scenarioSelect" style="width: 110px;">
                    <option value="">Load...</option>
                </select>
                <button type="button" class="btn btn-sm btn-info" id="loadScenarioBtn" title="Load">üìÇ</button>
                <button type="button" class="btn btn-sm btn-danger" id="deleteScenarioBtn" title="Delete">üóëÔ∏è</button>
            </div>
        </div>

        <!-- Advanced Metrics Collapse -->
        <div class="collapse mt-2" id="advancedMetricsCollapse">
            <div class="advanced-metrics-panel">
                <div class="row g-2">
                    <div class="col-auto">
                        <div class="inline-metric">
                            <span class="inline-metric-label">NSA/GFA %</span>
                            <input type="number" class="form-control form-control-sm inline-metric-input" id="efficiency_nsa_gfa" value="85.0" step="0.1" min="0" max="100" style="width: 65px;">
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="inline-metric">
                            <span class="inline-metric-label">GFA/GBA %</span>
                            <input type="number" class="form-control form-control-sm inline-metric-input" id="ratio_gfa_gba" value="92.9" step="0.1" min="0" max="100" style="width: 65px;">
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="inline-metric">
                            <span class="inline-metric-label">GBA</span>
                            <input type="number" class="form-control form-control-sm inline-metric-input bg-light" id="gba" readonly value="1050" style="width: 70px;">
                            <span class="inline-metric-unit">m¬≤</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="inline-metric">
                            <span class="inline-metric-label">NSA/GBA %</span>
                            <input type="number" class="form-control form-control-sm inline-metric-input bg-light" id="efficiency_nsa_gba" readonly value="79.0" style="width: 60px;">
                        </div>
                    </div>
                    <div class="col-auto ms-auto">
                        <button type="button" class="btn btn-primary btn-sm" id="calculateBtn">Recalculate</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics Bar - Always Visible -->
    <div class="metrics-bar mb-2">
        <div class="metrics-bar-inner">
            <div class="metric-item">
                <span class="metric-item-label">Margin</span>
                <span class="metric-item-value" id="summary_margin">0%</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Project IRR</span>
                <span class="metric-item-value" id="summary_irr">0%</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Total Dev Cost</span>
                <span class="metric-item-value" id="summary_tdc">$0</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Peak Funding</span>
                <span class="metric-item-value" id="summary_peak_funding">$0</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Equity IRR</span>
                <span class="metric-item-value" id="summary_equity_irr">0%</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Return on Equity</span>
                <span class="metric-item-value" id="summary_roe">0%</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">NPV (10%)</span>
                <span class="metric-item-value" id="summary_npv">$0</span>
            </div>
            <div class="metric-item">
                <span class="metric-item-label">Land Price</span>
                <span class="metric-item-value" id="summary_land_price">$0</span>
            </div>
        </div>
    </div>

    <!-- Residual Land Value Calculator -->
    <div class="residual-land-bar d-flex align-items-center gap-2 mb-2 p-2 rounded" style="background: var(--bg-secondary); border: 1px solid var(--border-color);">
        <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">RESIDUAL LAND VALUE:</span>
        <span style="font-size: 0.75rem; color: var(--text-secondary);">Target IRR:</span>
        <input type="number" id="target_irr" class="form-control form-control-sm" style="width: 80px; font-size: 0.75rem;" value="20" step="0.5" min="0" max="100">
        <span style="font-size: 0.75rem; color: var(--text-secondary);">%</span>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="solveLandForIRR()" style="font-size: 0.7rem; padding: 0.2rem 0.6rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
            Calculate
        </button>
        <span id="solved_land_value" class="fw-bold" style="font-size: 0.85rem; color: var(--schema-cyan);"></span>
        <button type="button" class="btn btn-sm btn-success d-none" id="apply_land_btn" onclick="applyLandValue()" style="font-size: 0.7rem; padding: 0.2rem 0.6rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><polyline points="20 6 9 17 4 12"></polyline></svg>
            Apply to Model
        </button>
    </div>

    <!-- Hidden form for compatibility -->
    <form id="projectSetupForm" style="display: none;"></form>

    <!-- Main Cashflow Table -->
    <div class="card" style="border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; vertical-align: -2px;"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>Project Cashflow</h6>
            <div class="d-flex gap-2 align-items-center">
                <button type="button" class="ai-all-btn" onclick="runAiOnAll()" id="aiAllBtn" title="Run AI benchmarks on all cost items">
                    <span class="spinner-border spinner-border-sm d-none" id="aiAllSpinner"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"></path></svg>AI Benchmark All
                </button>
            </div>
        </div>
        <div style="max-height: 75vh; overflow: auto;">
            <form id="acquisitionForm">
                <table class="table table-sm table-bordered mb-0" style="font-size: 0.75rem;">
                    <style>
                        .cashflow-input, .metric-select, .rate-input {
                            font-size: 0.75rem !important;
                        }
                        .table > tbody > tr > td:first-child {
                            min-width: 180px;
                        }
                    </style>
                    <thead class="table-dark" style="position: sticky; top: 0; z-index: 100;">
                        <tr>
                            <th style="position: sticky; left: 0; z-index: 101; background: #1a1a2e; min-width: 180px;">Cost Item</th>
                            <th style="min-width: 100px;">Amount</th>
                            <th style="min-width: 85px;">Metric</th>
                            <th style="min-width: 65px;">Rate</th>
                            <th style="min-width: 50px;">Start</th>
                            <th style="min-width: 55px;">Span</th>
                            <th style="min-width: 35px;">S</th>
                            <th id="monthlyHeaderSpan" colspan="48" class="text-center">Monthly Cashflow ‚Üí</th>
                        </tr>
                        <tr id="monthHeaderRow" class="table-dark">
                            <th style="position: sticky; left: 0; z-index: 101; background: var(--schema-navy, #0f172a);"></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <!-- Month numbers (M0, M1, M2...) will be inserted here by JavaScript -->
                        </tr>
                    </thead>
                    <tbody id="cashflowTableBody">
                        <!-- SECTION: ACQUISITION -->
                        <tr class="table-secondary">
                            <td colspan="100" class="fw-bold" style="position: sticky; left: 0; background: var(--slate-200, #e2e8f0);">
                                1. ACQUISITION
                                <button type="button" class="btn btn-sm btn-outline-secondary float-end" style="font-size: 0.7rem; padding: 0.1rem 0.4rem;" onclick="addCustomRow('acquisition')">+ Add Row</button>
                            </td>
                        </tr>
                        <tr class="cashflow-row" data-item="purchase_price">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Purchase Price</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('purchase_price', 'Purchase Price')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('purchase_price', 'Purchase Price')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="purchase_price" value="422500"></td>
                            <td>
                                <select class="form-select form-select-sm metric-select" id="purchase_price_metric" data-item="purchase_price">
                                    <option value="amount">Amount</option>
                                    <option value="per_gfa">$/GFA</option>
                                    <option value="per_nsa">$/NSA</option>
                                    <option value="per_gba">$/GBA</option>
                                    <option value="per_unit">$/Unit</option>
                                    <option value="pct_tdc">% TDC</option>
                                </select>
                            </td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="purchase_price_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="purchase_price_start" value="0" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="purchase_price_span" value="1" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="purchase_price_scurve" title="S-Curve distribution"></td>
                        </tr>
                        <tr class="cashflow-row" data-item="stamp_duty">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Stamp Duty</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('stamp_duty', 'Stamp Duty')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('stamp_duty', 'Stamp Duty')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="stamp_duty" value="20280"></td>
                            <td><select class="form-select form-select-sm metric-select" id="stamp_duty_metric" data-item="stamp_duty"><option value="amount">Amount</option><option value="per_gfa">$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="stamp_duty_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="stamp_duty_start" value="0" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="stamp_duty_span" value="1" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="stamp_duty_scurve"></td>
                        </tr>
                        <tr class="cashflow-row" data-item="legal_fees">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Legal Fees</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('legal_fees', 'Legal Fees')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('legal_fees', 'Legal Fees')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="legal_fees" value="4225"></td>
                            <td><select class="form-select form-select-sm metric-select" id="legal_fees_metric" data-item="legal_fees"><option value="amount">Amount</option><option value="per_gfa">$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="legal_fees_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="legal_fees_start" value="0" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="legal_fees_span" value="1" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="legal_fees_scurve"></td>
                        </tr>
                        <tr class="cashflow-row" data-item="other_acquisition">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Other Acquisition</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('other_acquisition', 'Other Acquisition Costs')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('other_acquisition', 'Other Acquisition Costs')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="other_acquisition" value="10894"></td>
                            <td><select class="form-select form-select-sm metric-select" id="other_acquisition_metric" data-item="other_acquisition"><option value="amount">Amount</option><option value="per_gfa">$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="other_acquisition_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="other_acquisition_start" value="0" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="other_acquisition_span" value="1" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="other_acquisition_scurve"></td>
                        </tr>

                        <!-- SECTION: DEVELOPMENT -->
                        <tr class="table-secondary">
                            <td colspan="100" class="fw-bold" style="position: sticky; left: 0; background: var(--slate-200, #e2e8f0);">
                                2. DEVELOPMENT
                                <button type="button" class="btn btn-sm btn-outline-secondary float-end" style="font-size: 0.7rem; padding: 0.1rem 0.4rem;" onclick="addCustomRow('development')">+ Add Row</button>
                            </td>
                        </tr>
                        <tr class="cashflow-row" data-item="construction_cost">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Construction Cost</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('construction_cost', 'Construction Cost')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('construction_cost', 'Construction Cost')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="construction_cost" value="3120000"></td>
                            <td><select class="form-select form-select-sm metric-select" id="construction_cost_metric" data-item="construction_cost"><option value="amount">Amount</option><option value="per_gfa" selected>$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="construction_cost_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="construction_cost_start" value="4" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="construction_cost_span" value="12" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="construction_cost_scurve"></td>
                        </tr>
                        <tr class="cashflow-row" data-item="demolition">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Demolition</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('demolition', 'Demolition')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('demolition', 'Demolition')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="demolition" value="18000"></td>
                            <td><select class="form-select form-select-sm metric-select" id="demolition_metric" data-item="demolition"><option value="amount">Amount</option><option value="per_gfa">$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="demolition_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="demolition_start" value="4" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="demolition_span" value="1" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="demolition_scurve"></td>
                        </tr>
                        <tr class="cashflow-row" data-item="professional_fees">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Professional Fees</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('professional_fees', 'Professional Fees')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('professional_fees', 'Professional Fees')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="professional_fees" value="312000"></td>
                            <td><select class="form-select form-select-sm metric-select" id="professional_fees_metric" data-item="professional_fees"><option value="amount">Amount</option><option value="per_gfa">$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc" selected>% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="professional_fees_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="professional_fees_start" value="4" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="professional_fees_span" value="1" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="professional_fees_scurve"></td>
                        </tr>
                        <tr class="cashflow-row" data-item="contingency">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Contingency</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('contingency', 'Contingency')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('contingency', 'Contingency')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="contingency" value="187200"></td>
                            <td><select class="form-select form-select-sm metric-select" id="contingency_metric" data-item="contingency"><option value="amount">Amount</option><option value="per_gfa">$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="contingency_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="contingency_start" value="10" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="contingency_span" value="1" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="contingency_scurve"></td>
                        </tr>
                        <tr class="cashflow-row" data-item="authority_fees">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Authority Fees</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('authority_fees', 'Authority Fees')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('authority_fees', 'Authority Fees')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="authority_fees" value="0"></td>
                            <td><select class="form-select form-select-sm metric-select" id="authority_fees_metric" data-item="authority_fees"><option value="amount">Amount</option><option value="per_gfa">$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="authority_fees_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="authority_fees_start" value="0" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="authority_fees_span" value="1" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="authority_fees_scurve"></td>
                        </tr>
                        <tr class="cashflow-row" data-item="marketing_costs">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Marketing Costs</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('marketing_costs', 'Marketing Costs')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('marketing_costs', 'Marketing Costs')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="marketing_costs" value="0"></td>
                            <td><select class="form-select form-select-sm metric-select" id="marketing_costs_metric" data-item="marketing_costs"><option value="amount">Amount</option><option value="per_gfa">$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="marketing_costs_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="marketing_costs_start" value="12" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="marketing_costs_span" value="6" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="marketing_costs_scurve"></td>
                        </tr>
                        <tr class="cashflow-row" data-item="admin_overhead">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Admin & O/H</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('admin_overhead', 'Admin & O/H Costs')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('admin_overhead', 'Admin & O/H Costs')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="admin_overhead" value="0"></td>
                            <td><select class="form-select form-select-sm metric-select" id="admin_overhead_metric" data-item="admin_overhead"><option value="amount">Amount</option><option value="per_gfa">$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="admin_overhead_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="admin_overhead_start" value="0" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="admin_overhead_span" value="18" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="admin_overhead_scurve"></td>
                        </tr>
                        <tr class="cashflow-row" data-item="commissions">
                            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Dev. Mgmt Fees</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('commissions', 'Development Management Fees')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('commissions', 'Development Management Fees')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="commissions" value="0"></td>
                            <td><select class="form-select form-select-sm metric-select" id="commissions_metric" data-item="commissions"><option value="amount">Amount</option><option value="per_gfa">$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="commissions_rate" step="0.01"></td>
                            <td><input type="number" class="form-control form-control-sm" id="commissions_start" value="18" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="commissions_span" value="1" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="commissions_scurve"></td>
                        </tr>

                        <!-- TDC SUBTOTAL -->
                        <tr class="table-warning cashflow-row" data-item="tdc_subtotal" data-is-calculated="true" data-is-summary="true">
                            <td style="position: sticky; left: 0; background: #fff3cd; z-index: 10; font-weight: 600;">TOTAL DEVELOPMENT COST (TDC)</td>
                            <td colspan="6" class="fw-bold" id="tdc_display">$0</td>
                        </tr>

                        <!-- SECTION: REVENUE -->
                        <tr class="table-secondary"><td colspan="100" class="fw-bold" style="position: sticky; left: 0; background: var(--slate-200, #e2e8f0);">3. REVENUE</td></tr>
                        <tr data-item="gdv" data-is-static="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; font-weight: 500;">
                                <div class="cost-item-cell">
                                    <span class="cost-item-name">Gross Revenue (GDV)</span>
                                    <div class="action-buttons">
                                        <button type="button" class="ai-assist-btn" onclick="openAiAssist('gdv', 'Gross Development Value')" title="AI Research">AI</button>
                                        <button type="button" class="notes-btn" onclick="openNotes('gdv', 'Gross Development Value')" title="Notes"><svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></button>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="gdv" value="7020000"></td>
                            <td><select class="form-select form-select-sm metric-select" id="gdv_metric" data-item="gdv"><option value="amount">Amount</option><option value="per_gfa" selected>$/GFA</option><option value="per_nsa">$/NSA</option><option value="per_gba">$/GBA</option><option value="per_unit">$/Unit</option><option value="pct_tdc">% TDC</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="gdv_rate" step="0.01"></td>
                            <td colspan="3" class="text-muted small">Static figure</td>
                        </tr>

                        <!-- Revenue Deductions (Static) -->
                        <tr data-item="selling_costs" data-is-static="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Less: Selling Costs</td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="selling_costs" value="0"></td>
                            <td><select class="form-select form-select-sm metric-select" id="selling_costs_metric" data-item="selling_costs"><option value="amount">Amount</option><option value="pct_gdv" selected>% GDV</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="selling_costs_rate" step="0.01"></td>
                            <td colspan="3" class="text-muted small">Applied to net revenue</td>
                        </tr>
                        <tr data-item="gst_on_sale" data-is-static="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Less: GST on Sale</td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="gst_on_sale" value="0"></td>
                            <td><select class="form-select form-select-sm metric-select" id="gst_on_sale_metric" data-item="gst_on_sale"><option value="amount">Amount</option><option value="pct_gdv" selected>% GDV</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="gst_on_sale_rate" step="0.01"></td>
                            <td colspan="3" class="text-muted small">Applied to net revenue</td>
                        </tr>
                        <tr data-item="agent_commissions" data-is-static="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Less: Agent Commissions</td>
                            <td><input type="number" class="form-control form-control-sm cashflow-input" id="agent_commissions" value="0"></td>
                            <td><select class="form-select form-select-sm metric-select" id="agent_commissions_metric" data-item="agent_commissions"><option value="amount">Amount</option><option value="pct_gdv" selected>% GDV</option></select></td>
                            <td><input type="number" class="form-control form-control-sm rate-input" id="agent_commissions_rate" step="0.01"></td>
                            <td colspan="3" class="text-muted small">Applied to net revenue</td>
                        </tr>

                        <!-- Net Revenue (with timing) -->
                        <tr class="table-success cashflow-row" data-item="net_revenue" data-is-revenue="true" data-is-net-revenue="true">
                            <td style="position: sticky; left: 0; background: #d1e7dd; z-index: 10; font-weight: 600;">NET REVENUE</td>
                            <td class="small" id="net_revenue_display">$0</td>
                            <td colspan="2" class="text-muted small">GDV - Deductions</td>
                            <td><input type="number" class="form-control form-control-sm" id="net_revenue_start" value="18" min="0"></td>
                            <td><input type="number" class="form-control form-control-sm" id="net_revenue_span" value="1" min="1"></td>
                            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="net_revenue_scurve"></td>
                        </tr>

                        <!-- PROJECT CASHFLOW SUBTOTAL -->
                        <tr class="table-info cashflow-row" data-item="project_cashflow" data-is-calculated="true" data-is-summary="true">
                            <td style="position: sticky; left: 0; background: #cfe2ff; z-index: 10; font-weight: 600;">PROJECT CASHFLOW</td>
                            <td colspan="6" class="small">Net Revenue - Costs (before financing)</td>
                        </tr>

                        <!-- SECTION: FINANCING -->
                        <tr class="table-secondary"><td colspan="100" class="fw-bold" style="position: sticky; left: 0; background: var(--slate-200, #e2e8f0);">4. FINANCING</td></tr>

                        <!-- Equity Parameters -->
                        <tr class="table-info"><td colspan="100" style="position: sticky; left: 0; background: #cfe2ff; font-weight: 600;">4.1 EQUITY FACILITY</td></tr>
                        <tr class="bg-light">
                            <td style="position: sticky; left: 0; background: #f8f9fa; z-index: 10; font-weight: 500;">Facility Limit</td>
                            <td colspan="3">
                                <div class="d-flex align-items-center gap-2">
                                    <input type="number" class="form-control form-control-sm" style="width: 80px;" id="equity_pct_input" value="25" step="0.1" min="0" max="100">
                                    <span class="text-muted small">% of TDC =</span>
                                    <strong class="text-primary" id="equity_limit_calc">$0</strong>
                                </div>
                            </td>
                            <td colspan="3"></td>
                        </tr>
                        <tr class="bg-light">
                            <td style="position: sticky; left: 0; background: #f8f9fa; z-index: 10; font-weight: 500;">Interest Rate</td>
                            <td colspan="3">
                                <div class="d-flex align-items-center gap-2">
                                    <input type="number" class="form-control form-control-sm" style="width: 80px;" id="equity_interest_rate" value="0" step="0.1" min="0">
                                    <span class="text-muted small">% p.a. (capitalizing monthly)</span>
                                </div>
                            </td>
                            <td colspan="3"></td>
                        </tr>
                        <input type="hidden" id="equity_max_limit" value="1275000">

                        <!-- Equity Cashflow Rows -->
                        <tr class="cashflow-row" data-item="equity_opening" data-is-calculated="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Opening Balance</td>
                            <td colspan="6" class="text-muted small">Calculated</td>
                        </tr>
                        <tr class="cashflow-row" data-item="equity_drawdown" data-is-calculated="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Drawdown</td>
                            <td colspan="6" class="text-muted small">Auto-calculated from costs</td>
                        </tr>
                        <tr class="cashflow-row" data-item="equity_interest" data-is-calculated="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Interest</td>
                            <td colspan="6" class="text-muted small">Balance √ó Rate / 12</td>
                        </tr>
                        <tr class="cashflow-row" data-item="equity_repayment" data-is-calculated="true" data-is-revenue="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Repayment</td>
                            <td colspan="6" class="text-muted small">At project completion</td>
                        </tr>
                        <tr class="cashflow-row" data-item="equity_cashflow_monthly" data-is-calculated="true" data-is-summary="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; font-weight: 600; padding-left: 1.5rem;">Equity Cashflow (Monthly)</td>
                            <td colspan="6" class="small">Monthly: -Drawdown - Interest + Repayment</td>
                        </tr>
                        <tr class="cashflow-row table-warning" data-item="equity_cashflow" data-is-calculated="true" data-is-summary="true">
                            <td style="position: sticky; left: 0; background: #fff3cd; z-index: 10; font-weight: 600;">Equity Cashflow (Cumulative)</td>
                            <td colspan="6" class="small">Cumulative: -Drawdown - Interest + Repayment</td>
                        </tr>

                        <!-- Senior Loan Parameters -->
                        <tr class="table-info"><td colspan="100" style="position: sticky; left: 0; background: #cfe2ff; font-weight: 600;">4.2 SENIOR DEBT FACILITY</td></tr>
                        <tr class="bg-light">
                            <td style="position: sticky; left: 0; background: #f8f9fa; z-index: 10; font-weight: 500;">Facility Limit</td>
                            <td colspan="5">
                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                    <select class="form-select form-select-sm" style="width: 100px;" id="loan_calc_method">
                                        <option value="manual">Manual $</option>
                                        <option value="lvr">% LVR</option>
                                        <option value="ltc" selected>% LTC</option>
                                    </select>
                                    <input type="number" class="form-control form-control-sm" style="width: 100px;" id="loan_calc_pct" value="70" step="0.1">
                                    <span class="text-muted small">=</span>
                                    <strong class="text-primary" id="loan_calc_result">$0</strong>
                                    <span class="text-muted small ms-2">‚Üí</span>
                                    <span class="text-muted small">Max Limit:</span>
                                    <input type="number" class="form-control form-control-sm cashflow-input" style="width: 120px;" id="loan_max_limit" value="3315000">
                                </div>
                            </td>
                            <td colspan="1"></td>
                        </tr>
                        <tr class="bg-light">
                            <td style="position: sticky; left: 0; background: #f8f9fa; z-index: 10; font-weight: 500;">Interest Rate</td>
                            <td colspan="5">
                                <div class="d-flex align-items-center gap-2">
                                    <input type="number" class="form-control form-control-sm" style="width: 80px;" id="loan_interest_rate" value="6" step="0.1" min="0">
                                    <span class="text-muted small">% p.a. (capitalizing monthly)</span>
                                </div>
                            </td>
                            <td colspan="1"></td>
                        </tr>
                        <tr class="bg-light">
                            <td style="position: sticky; left: 0; background: #f8f9fa; z-index: 10; font-weight: 500;">Fees</td>
                            <td colspan="5">
                                <div class="d-flex align-items-center gap-3 flex-wrap">
                                    <div class="d-flex align-items-center gap-1">
                                        <span class="text-muted small">Establishment:</span>
                                        <input type="number" class="form-control form-control-sm" style="width: 70px;" id="loan_establishment_fee_pct" value="2" step="0.1" min="0">
                                        <span class="text-muted small">%</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <span class="text-muted small">Line Fee:</span>
                                        <input type="number" class="form-control form-control-sm" style="width: 70px;" id="loan_line_fee_pct" value="0.5" step="0.1" min="0">
                                        <span class="text-muted small">% p.a.</span>
                                    </div>
                                </div>
                            </td>
                            <td colspan="1"></td>
                        </tr>

                        <!-- Senior Loan Cashflow Rows -->
                        <tr class="cashflow-row" data-item="loan_opening" data-is-calculated="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Opening Balance</td>
                            <td colspan="6" class="text-muted small">Calculated</td>
                        </tr>
                        <tr class="cashflow-row" data-item="loan_drawdown" data-is-calculated="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Drawdown</td>
                            <td colspan="6" class="text-muted small">Auto-calculated from costs</td>
                        </tr>
                        <tr class="cashflow-row" data-item="loan_establishment_fee" data-is-calculated="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Establishment Fee</td>
                            <td colspan="6" class="text-muted small">One-time upfront fee</td>
                        </tr>
                        <tr class="cashflow-row" data-item="loan_line_fee" data-is-calculated="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Line Fee</td>
                            <td colspan="6" class="text-muted small">Monthly commitment fee</td>
                        </tr>
                        <tr class="cashflow-row" data-item="loan_interest" data-is-calculated="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Interest</td>
                            <td colspan="6" class="text-muted small">Balance √ó Rate / 12</td>
                        </tr>
                        <tr class="cashflow-row" data-item="loan_repayment" data-is-calculated="true" data-is-revenue="true">
                            <td style="position: sticky; left: 0; background: white; z-index: 10; padding-left: 1.5rem;">Repayment</td>
                            <td colspan="6" class="text-muted small">At project completion</td>
                        </tr>
                        <tr class="cashflow-row table-warning" data-item="loan_cashflow" data-is-calculated="true" data-is-summary="true">
                            <td style="position: sticky; left: 0; background: #fff3cd; z-index: 10; font-weight: 600;">Loan Cashflow (Cumulative)</td>
                            <td colspan="6" class="small">Cumulative: -Drawdown - Interest + Repayment</td>
                        </tr>

                        <!-- Hidden inputs for backend -->
                        <input type="hidden" id="gdv_rate_per_sqm" value="7200">
                        <input type="hidden" id="discount_rate" value="10">
                        <input type="hidden" id="fsr_calc" value="1.5">
                        <input type="hidden" id="loan_opening_start" value="0">
                        <input type="hidden" id="loan_opening_span" value="1">
                        <input type="hidden" id="equity_opening_start" value="0">
                        <input type="hidden" id="equity_opening_span" value="1">
                        <input type="hidden" id="mezz_opening" value="0">
                        <input type="hidden" id="mezz_max_limit" value="0">
                        <input type="hidden" id="mezz_interest_rate" value="12">
                    </tbody>
                </table>
            </form>
        </div>
    </div>

    <!-- Metrics Display -->
    <div id="metricsSection" style="display: none;">
        <div class="row mt-3">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body p-2">
                        <h6 class="mb-0">Project IRR</h6>
                        <h4 id="metric_irr">-</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body p-2">
                        <h6 class="mb-0">Profit</h6>
                        <h4 id="metric_profit">-</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body p-2">
                        <h6 class="mb-0">Margin on GDV</h6>
                        <h4 id="metric_margin">-</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notes & Workings Modal -->
<div class="modal fade notes-modal" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notesModalLabel">Notes & Workings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="notes_item_id">

                <!-- Current Value Summary -->
                <div class="notes-section mb-3">
                    <div class="notes-section-header">
                        <span>Current Value</span>
                        <span id="notes_current_value" class="text-primary fw-bold">$0</span>
                    </div>
                    <div class="notes-section-body">
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label small text-muted mb-1">Metric</label>
                                <div id="notes_metric_display" class="fw-semibold">Amount</div>
                            </div>
                            <div class="col-4">
                                <label class="form-label small text-muted mb-1">Rate</label>
                                <div id="notes_rate_display" class="fw-semibold">-</div>
                            </div>
                            <div class="col-4">
                                <label class="form-label small text-muted mb-1">Timing</label>
                                <div id="notes_timing_display" class="fw-semibold">M0, 1 month</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workings / Calculations -->
                <div class="notes-section mb-3">
                    <div class="notes-section-header">
                        <span>Workings & Calculations</span>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertFormulaTemplate()">+ Formula</button>
                    </div>
                    <div class="notes-section-body">
                        <textarea class="form-control notes-workings-area" id="notes_workings" rows="6" placeholder="Enter your calculations, formulas, and working notes here...

Example:
Land Cost: $422,500
Rate per sqm: $422,500 / 650 sqm = $650/sqm
Benchmark: $500-$800/sqm (Sydney metro)"></textarea>
                    </div>
                </div>

                <!-- Source / References -->
                <div class="notes-section mb-3">
                    <div class="notes-section-header">
                        <span>Sources & References</span>
                    </div>
                    <div class="notes-section-body">
                        <textarea class="form-control" id="notes_sources" rows="3" placeholder="Add links to research, quotes, comparable sales, etc."></textarea>
                    </div>
                </div>

                <!-- Assumptions -->
                <div class="notes-section">
                    <div class="notes-section-header">
                        <span>Key Assumptions</span>
                    </div>
                    <div class="notes-section-body">
                        <textarea class="form-control" id="notes_assumptions" rows="2" placeholder="List key assumptions underlying this figure..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
            </div>
        </div>
    </div>
</div>

<!-- AI Assist Modal -->
<div class="modal fade" id="aiAssistModal" tabindex="-1" aria-labelledby="aiAssistModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title" id="aiAssistModalLabel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"></path></svg> AI Research Assistant
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="ai_item_id">
                <input type="hidden" id="ai_item_name">

                <!-- Current Context -->
                <div class="ai-research-panel mb-3">
                    <div class="ai-research-header">
                        <div class="ai-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"></path></svg></div>
                        <div>
                            <strong id="ai_context_title">Construction Cost</strong>
                            <div class="small text-muted">Current: <span id="ai_current_value">$3,120,000</span> (<span id="ai_current_rate">$3,200/GFA</span>)</div>
                        </div>
                    </div>

                    <!-- AI Query -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">What would you like to research?</label>
                        <select class="form-select form-select-sm mb-2" id="ai_query_type">
                            <option value="benchmark">Benchmark against market rates</option>
                            <option value="breakdown">Get detailed cost breakdown</option>
                            <option value="factors">Identify cost drivers & factors</option>
                            <option value="trends">Current market trends</option>
                            <option value="custom">Custom question</option>
                        </select>
                        <textarea class="form-control" id="ai_custom_query" rows="2" placeholder="Enter your specific question..." style="display: none;"></textarea>
                    </div>

                    <!-- Location Context -->
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small">Location</label>
                            <input type="text" class="form-control form-control-sm" id="ai_location" value="Sydney, NSW" placeholder="City, State">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Project Type</label>
                            <select class="form-select form-select-sm" id="ai_project_type">
                                <option value="residential_apartment">Residential Apartments</option>
                                <option value="residential_townhouse">Townhouses</option>
                                <option value="mixed_use">Mixed Use</option>
                                <option value="commercial">Commercial</option>
                                <option value="industrial">Industrial</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary w-100" onclick="runAiResearch()" id="ai_research_btn">
                        <span class="spinner-border spinner-border-sm d-none" id="ai_spinner"></span>
                        Research with AI
                    </button>
                </div>

                <!-- AI Results (hidden initially) -->
                <div id="ai_results_container" style="display: none;">
                    <div class="notes-section">
                        <div class="notes-section-header">
                            <span>AI Research Results</span>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyAiSuggestion()">Apply Suggestion</button>
                        </div>
                        <div class="notes-section-body">
                            <!-- Benchmark Grid -->
                            <div class="ai-benchmark-grid mb-3" id="ai_benchmark_grid">
                                <!-- Populated by JS -->
                            </div>

                            <!-- AI Analysis -->
                            <div id="ai_analysis_text" class="small" style="white-space: pre-wrap;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="addAiToNotes()">Add to Notes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ===== HELPER FUNCTIONS =====
    // Parse float from input value, handling comma separators
    function parseInputFloat(value) {
        if (typeof value === 'string') {
            return parseFloat(value.replace(/,/g, '')) || 0;
        }
        return parseFloat(value) || 0;
    }

    // ===== NOTES & WORKINGS FUNCTIONS =====
    // Store notes data in localStorage
    let notesData = JSON.parse(localStorage.getItem('cashflow_notes') || '{}');

    function openNotes(itemId, itemName) {
        document.getElementById('notes_item_id').value = itemId;
        document.getElementById('notesModalLabel').textContent = `Notes & Workings: ${itemName}`;

        // Get current value
        const amountInput = document.getElementById(itemId);
        const metricSelect = document.getElementById(itemId + '_metric');
        const rateInput = document.getElementById(itemId + '_rate');
        const startInput = document.getElementById(itemId + '_start');
        const spanInput = document.getElementById(itemId + '_span');

        // Display current values
        if (amountInput) {
            const amount = parseInputFloat(amountInput.value);
            document.getElementById('notes_current_value').textContent = '$' + amount.toLocaleString('en-AU');
        }
        if (metricSelect) {
            document.getElementById('notes_metric_display').textContent = metricSelect.options[metricSelect.selectedIndex].text;
        }
        if (rateInput) {
            const rate = parseFloat(rateInput.value) || 0;
            document.getElementById('notes_rate_display').textContent = rate > 0 ? rate.toFixed(2) : '-';
        }
        if (startInput && spanInput) {
            document.getElementById('notes_timing_display').textContent = `M${startInput.value}, ${spanInput.value} month(s)`;
        }

        // Load existing notes
        const itemNotes = notesData[itemId] || {};
        document.getElementById('notes_workings').value = itemNotes.workings || '';
        document.getElementById('notes_sources').value = itemNotes.sources || '';
        document.getElementById('notes_assumptions').value = itemNotes.assumptions || '';

        // Update notes button appearance
        updateNotesButtonState(itemId);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('notesModal'));
        modal.show();
    }

    function saveNotes() {
        const itemId = document.getElementById('notes_item_id').value;

        notesData[itemId] = {
            workings: document.getElementById('notes_workings').value,
            sources: document.getElementById('notes_sources').value,
            assumptions: document.getElementById('notes_assumptions').value,
            lastUpdated: new Date().toISOString()
        };

        localStorage.setItem('cashflow_notes', JSON.stringify(notesData));

        // Update button state
        updateNotesButtonState(itemId);

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('notesModal')).hide();

        // Show success feedback
        showToast('Notes saved successfully');
    }

    function updateNotesButtonState(itemId) {
        const btn = document.querySelector(`[onclick="openNotes('${itemId}'"]`);
        if (btn) {
            const hasNotes = notesData[itemId] &&
                (notesData[itemId].workings || notesData[itemId].sources || notesData[itemId].assumptions);
            btn.classList.toggle('has-notes', hasNotes);
        }
    }

    function insertFormulaTemplate() {
        const textarea = document.getElementById('notes_workings');
        const template = `
=== Calculation ===
Base Amount: $0
Calculation:
Result: $0

=== Benchmark Check ===
Low: $0
Mid: $0
High: $0
`;
        textarea.value = textarea.value + template;
        textarea.focus();
    }

    // ===== AI ASSIST FUNCTIONS =====
    let lastAiResult = null;

    function openAiAssist(itemId, itemName) {
        document.getElementById('ai_item_id').value = itemId;
        document.getElementById('ai_item_name').value = itemName;
        document.getElementById('ai_context_title').textContent = itemName;

        // Get current values
        const amountInput = document.getElementById(itemId);
        const metricSelect = document.getElementById(itemId + '_metric');
        const rateInput = document.getElementById(itemId + '_rate');

        if (amountInput) {
            const amount = parseInputFloat(amountInput.value);
            document.getElementById('ai_current_value').textContent = '$' + amount.toLocaleString('en-AU');
        }
        if (rateInput && metricSelect) {
            const rate = parseFloat(rateInput.value) || 0;
            const metricText = metricSelect.options[metricSelect.selectedIndex].text;
            document.getElementById('ai_current_rate').textContent = rate > 0 ? `$${rate.toFixed(0)}/${metricText.replace('$/', '')}` : '-';
        }

        // Reset results
        document.getElementById('ai_results_container').style.display = 'none';
        document.getElementById('ai_benchmark_grid').innerHTML = '';
        document.getElementById('ai_analysis_text').textContent = '';
        lastAiResult = null;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('aiAssistModal'));
        modal.show();
    }

    // Toggle custom query visibility
    document.addEventListener('DOMContentLoaded', function() {
        const queryTypeSelect = document.getElementById('ai_query_type');
        if (queryTypeSelect) {
            queryTypeSelect.addEventListener('change', function() {
                document.getElementById('ai_custom_query').style.display =
                    this.value === 'custom' ? 'block' : 'none';
            });
        }
    });

    function runAiResearch() {
        const itemId = document.getElementById('ai_item_id').value;
        const itemName = document.getElementById('ai_item_name').value;
        const queryType = document.getElementById('ai_query_type').value;
        const location = document.getElementById('ai_location').value;
        const projectType = document.getElementById('ai_project_type').value;
        const customQuery = document.getElementById('ai_custom_query').value;

        // Show spinner
        document.getElementById('ai_spinner').classList.remove('d-none');
        document.getElementById('ai_research_btn').disabled = true;

        // Simulate AI response (in production, this would call an API)
        setTimeout(() => {
            // Generate mock benchmarks based on item type
            const benchmarks = generateMockBenchmarks(itemId, itemName, location, projectType);
            lastAiResult = benchmarks;

            // Display results
            displayAiBenchmarks(benchmarks);
            document.getElementById('ai_results_container').style.display = 'block';

            // Hide spinner
            document.getElementById('ai_spinner').classList.add('d-none');
            document.getElementById('ai_research_btn').disabled = false;
        }, 1500);
    }

    function generateMockBenchmarks(itemId, itemName, location, projectType) {
        // Mock benchmark data based on item type
        const benchmarkData = {
            construction_cost: {
                low: { value: 2800, label: 'Budget', source: 'Rawlinsons 2024' },
                mid: { value: 3500, label: 'Standard', source: 'Industry avg' },
                high: { value: 4500, label: 'Premium', source: 'QS Reports' },
                unit: '$/GFA',
                analysis: `Construction Cost Benchmarks for ${projectType.replace('_', ' ')} in ${location}:

Based on current market data:
- Budget build (basic finishes): $2,800 - $3,200/GFA
- Standard build (mid-market): $3,200 - $4,000/GFA
- Premium build (high-end finishes): $4,000 - $5,000/GFA

Key cost drivers:
1. Site conditions & access
2. Building height & complexity
3. Finish quality & specifications
4. Current material prices
5. Labor market conditions

Recommendation: For ${location}, a rate of $3,400-$3,800/GFA is typical for standard residential apartments.`
            },
            purchase_price: {
                low: { value: 500, label: 'Inner Suburbs', source: 'RP Data' },
                mid: { value: 750, label: 'Middle Ring', source: 'Domain' },
                high: { value: 1200, label: 'Premium', source: 'CoreLogic' },
                unit: '$/sqm (site)',
                analysis: `Land Value Analysis for ${location}:

Site value benchmarks ($/sqm):
- Outer suburban: $400 - $600/sqm
- Middle ring: $600 - $900/sqm
- Inner suburban: $800 - $1,500/sqm
- CBD fringe: $1,500 - $3,000/sqm

Factors affecting land value:
1. Zoning & permissible FSR
2. Transport accessibility
3. Local amenities
4. Development potential
5. Market conditions

Note: Rates vary significantly by LGA and specific location.`
            },
            professional_fees: {
                low: { value: 8, label: 'Simple Project', source: 'AIQS' },
                mid: { value: 10, label: 'Standard', source: 'Industry' },
                high: { value: 14, label: 'Complex', source: 'Consultants' },
                unit: '% of Construction',
                analysis: `Professional Fees Breakdown:

Typical fee structure as % of construction cost:
- Architect: 3-5%
- Structural Engineer: 1-2%
- Civil Engineer: 0.5-1%
- Quantity Surveyor: 0.5-1%
- Project Manager: 2-3%
- Other consultants: 1-2%

Total: 8-14% depending on project complexity

Recommendations:
- Allow 10% for standard projects
- 12-14% for complex or high-rise developments`
            },
            gdv: {
                low: { value: 8500, label: 'Affordable', source: 'REA' },
                mid: { value: 12000, label: 'Standard', source: 'Domain' },
                high: { value: 18000, label: 'Premium', source: 'CoreLogic' },
                unit: '$/sqm NSA',
                analysis: `Sales Rate Analysis for ${location}:

Residential apartment rates ($/sqm NSA):
- Affordable/entry level: $7,000 - $9,000
- Standard/mid-market: $10,000 - $14,000
- Premium/luxury: $15,000 - $25,000+

Key value drivers:
1. Views & aspect
2. Floor level
3. Unit size & layout
4. Finishes quality
5. Building amenities
6. Location desirability

Current market trend: Slight upward pressure on prices in ${location}.`
            }
        };

        // Default benchmark for items not specifically defined
        const defaultBenchmark = {
            low: { value: 0, label: 'Low', source: 'Estimate' },
            mid: { value: 0, label: 'Mid', source: 'Industry' },
            high: { value: 0, label: 'High', source: 'Premium' },
            unit: 'varies',
            analysis: `No specific benchmark data available for ${itemName}.

Consider:
1. Researching industry standards
2. Getting quotes from suppliers
3. Consulting with specialists
4. Reviewing similar projects`
        };

        return benchmarkData[itemId] || defaultBenchmark;
    }

    function displayAiBenchmarks(benchmarks) {
        const grid = document.getElementById('ai_benchmark_grid');
        grid.innerHTML = `
            <div class="ai-benchmark-item">
                <div class="ai-benchmark-label">${benchmarks.low.label}</div>
                <div class="ai-benchmark-value">$${benchmarks.low.value.toLocaleString()}</div>
                <div class="ai-benchmark-source">${benchmarks.unit}</div>
            </div>
            <div class="ai-benchmark-item" style="border-color: var(--schema-cyan));">
                <div class="ai-benchmark-label">${benchmarks.mid.label}</div>
                <div class="ai-benchmark-value text-primary">$${benchmarks.mid.value.toLocaleString()}</div>
                <div class="ai-benchmark-source">${benchmarks.unit}</div>
            </div>
            <div class="ai-benchmark-item">
                <div class="ai-benchmark-label">${benchmarks.high.label}</div>
                <div class="ai-benchmark-value">$${benchmarks.high.value.toLocaleString()}</div>
                <div class="ai-benchmark-source">${benchmarks.unit}</div>
            </div>
        `;

        document.getElementById('ai_analysis_text').textContent = benchmarks.analysis;
    }

    function applyAiSuggestion() {
        if (!lastAiResult) return;

        const itemId = document.getElementById('ai_item_id').value;
        const rateInput = document.getElementById(itemId + '_rate');

        if (rateInput && lastAiResult.mid) {
            rateInput.value = lastAiResult.mid.value;
            // Trigger update
            rateInput.dispatchEvent(new Event('input'));
            showToast('Applied mid-range benchmark rate');
        }
    }

    function addAiToNotes() {
        if (!lastAiResult) return;

        const itemId = document.getElementById('ai_item_id').value;
        const itemName = document.getElementById('ai_item_name').value;

        // Add to notes
        const existingNotes = notesData[itemId] || {};
        const aiNotes = `
=== AI Research (${new Date().toLocaleDateString()}) ===
${lastAiResult.analysis}

Benchmarks:
- ${lastAiResult.low.label}: $${lastAiResult.low.value.toLocaleString()} ${lastAiResult.unit}
- ${lastAiResult.mid.label}: $${lastAiResult.mid.value.toLocaleString()} ${lastAiResult.unit}
- ${lastAiResult.high.label}: $${lastAiResult.high.value.toLocaleString()} ${lastAiResult.unit}
`;

        existingNotes.workings = (existingNotes.workings || '') + aiNotes;
        existingNotes.lastUpdated = new Date().toISOString();
        notesData[itemId] = existingNotes;

        localStorage.setItem('cashflow_notes', JSON.stringify(notesData));
        updateNotesButtonState(itemId);

        showToast('AI research added to notes');
        bootstrap.Modal.getInstance(document.getElementById('aiAssistModal')).hide();
    }

    // ===== RUN AI ON ALL ITEMS =====
    const aiEnabledItems = [
        'purchase_price', 'stamp_duty', 'legal_fees', 'other_acquisition',
        'construction_cost', 'demolition', 'professional_fees', 'contingency',
        'authority_fees', 'marketing_costs', 'admin_overhead', 'commissions', 'gdv'
    ];

    let aiAllResults = {};

    async function runAiOnAll() {
        const btn = document.getElementById('aiAllBtn');
        const spinner = document.getElementById('aiAllSpinner');
        const location = 'Sydney, NSW';
        const projectType = 'residential_apartment';

        // Show loading state
        btn.disabled = true;
        spinner.classList.remove('d-none');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

        aiAllResults = {};
        let processedCount = 0;

        // Process each item with a small delay between
        for (const itemId of aiEnabledItems) {
            const benchmarks = generateMockBenchmarks(itemId, itemId, location, projectType);
            aiAllResults[itemId] = benchmarks;

            // Update progress
            processedCount++;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ${processedCount}/${aiEnabledItems.length}`;

            // Small delay for UX
            await new Promise(resolve => setTimeout(resolve, 150));
        }

        // Hide loading state
        spinner.classList.add('d-none');
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"></path></svg>AI Benchmark All';

        // Show results modal
        showAiAllResultsModal();
    }

    function showAiAllResultsModal() {
        // Create results summary
        let resultsHtml = '<div class="ai-all-results">';
        resultsHtml += '<p class="mb-3">AI has analyzed all cost items and generated benchmarks. Review and apply:</p>';
        resultsHtml += '<div class="table-responsive"><table class="table table-sm table-bordered">';
        resultsHtml += '<thead class="table-light"><tr><th>Item</th><th>Current</th><th>Benchmark (Mid)</th><th>Apply</th></tr></thead><tbody>';

        aiEnabledItems.forEach(itemId => {
            const benchmark = aiAllResults[itemId];
            if (!benchmark || benchmark.mid.value === 0) return;

            const currentInput = document.getElementById(itemId);
            const currentValue = currentInput ? parseInputFloat(currentInput.value) : 0;
            const benchmarkValue = benchmark.mid.value;

            const variance = currentValue > 0 ? ((benchmarkValue - currentValue) / currentValue * 100) : 0;
            const varianceClass = Math.abs(variance) > 20 ? 'text-warning' : 'text-success';

            resultsHtml += `
                <tr>
                    <td class="fw-semibold">${itemId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                    <td>$${currentValue.toLocaleString()}</td>
                    <td>
                        $${benchmarkValue.toLocaleString()} <span class="small ${varianceClass}">${benchmark.unit}</span>
                    </td>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input ai-apply-checkbox" data-item="${itemId}" data-value="${benchmarkValue}" checked>
                    </td>
                </tr>
            `;
        });

        resultsHtml += '</tbody></table></div>';
        resultsHtml += '<div class="alert alert-info small mt-2 mb-0"><strong>Note:</strong> Benchmarks are indicative. Review each value before applying.</div>';
        resultsHtml += '</div>';

        // Show in a modal (reuse AI modal)
        document.getElementById('aiAssistModalLabel').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"></path></svg> AI Benchmark Results - All Items';
        document.getElementById('ai_results_container').style.display = 'none';

        // Create custom content
        const modalBody = document.querySelector('#aiAssistModal .modal-body');
        const originalContent = modalBody.innerHTML;

        modalBody.innerHTML = resultsHtml;

        // Update footer buttons
        const modalFooter = document.querySelector('#aiAssistModal .modal-footer');
        modalFooter.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="restoreAiModal()">Cancel</button>
            <button type="button" class="btn btn-success" onclick="applyAllAiBenchmarks()">Apply Selected</button>
        `;

        // Store original content for restoration
        window.aiModalOriginalContent = originalContent;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('aiAssistModal'));
        modal.show();
    }

    function restoreAiModal() {
        if (window.aiModalOriginalContent) {
            document.querySelector('#aiAssistModal .modal-body').innerHTML = window.aiModalOriginalContent;
            document.querySelector('#aiAssistModal .modal-footer').innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="addAiToNotes()">Add to Notes</button>
            `;
        }
    }

    function applyAllAiBenchmarks() {
        const checkboxes = document.querySelectorAll('.ai-apply-checkbox:checked');
        let appliedCount = 0;

        checkboxes.forEach(checkbox => {
            const itemId = checkbox.dataset.item;
            const value = parseFloat(checkbox.dataset.value);
            const rateInput = document.getElementById(itemId + '_rate');

            if (rateInput) {
                rateInput.value = value;
                rateInput.dispatchEvent(new Event('input'));
                appliedCount++;
            }
        });

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('aiAssistModal')).hide();
        restoreAiModal();

        // Show feedback
        showToast(`Applied ${appliedCount} benchmark rates`);

        // Trigger full recalculation
        updateTDCDisplay();
        updateEquityFromPercentage();
        updateLoanFromCalculator();
    }

    // Toast notification helper
    function showToast(message) {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-body bg-success text-white rounded">
                    ${message}
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // Initialize notes button states on load
    document.addEventListener('DOMContentLoaded', function() {
        Object.keys(notesData).forEach(itemId => {
            updateNotesButtonState(itemId);
        });
    });

    // ===== INITIALIZE MONTH HEADERS AND CASHFLOW CELLS =====
    let NUM_MONTHS = 36; // Default, will be calculated based on project duration

    // Calculate required number of months based on project timeline
    function calculateRequiredMonths() {
        let maxMonth = 36; // Minimum default (3 years)

        // Check all rows to find the maximum end month
        document.querySelectorAll('.cashflow-row:not([data-is-calculated="true"])').forEach(row => {
            const itemId = row.getAttribute('data-item');
            const startInput = document.getElementById(itemId + '_start');
            const spanInput = document.getElementById(itemId + '_span');

            if (startInput && spanInput) {
                const start = parseInt(startInput.value) || 0;
                const span = parseInt(spanInput.value) || 1;
                const endMonth = start + span;

                if (endMonth > maxMonth) {
                    maxMonth = endMonth;
                }
            }
        });

        // Add 12 month buffer for repayments/completion
        const requiredMonths = maxMonth + 12;

        // Ensure minimum of 48 months (4 years) for typical development projects
        return Math.max(requiredMonths, 48);
    }

    // Reinitialize month headers with new month count
    function reinitializeMonthHeaders() {
        NUM_MONTHS = calculateRequiredMonths();
        const monthHeaderRow = document.getElementById('monthHeaderRow');
        monthHeaderRow.innerHTML = ''; // Clear existing headers

        // Update the "Monthly Cashflow ‚Üí" header colspan
        const monthlyHeaderSpan = document.getElementById('monthlyHeaderSpan');
        if (monthlyHeaderSpan) {
            monthlyHeaderSpan.setAttribute('colspan', NUM_MONTHS);
        }

        // Add empty cells for the input columns (7 columns: Cost Item, Amount, Metric, Rate, Start, Span, S)
        for (let j = 0; j < 7; j++) {
            const th = document.createElement('th');
            th.style.position = j === 0 ? 'sticky' : '';
            th.style.left = j === 0 ? '0' : '';
            th.style.zIndex = j === 0 ? '101' : '';
            th.style.background = j === 0 ? '#6c757d' : '';
            monthHeaderRow.appendChild(th);
        }

        // Add month number headers with dates
        const startDateInput = document.getElementById('start_date');
        const startDate = startDateInput && startDateInput.value ? new Date(startDateInput.value) : new Date();

        for (let i = 0; i < NUM_MONTHS; i++) {
            const th = document.createElement('th');
            th.className = 'text-center month-header';
            th.style.minWidth = '70px';

            // Calculate month date
            const monthDate = new Date(startDate);
            monthDate.setMonth(monthDate.getMonth() + i);
            const monthStr = monthDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });

            // Create HTML with month number and date
            th.innerHTML = `<span class="month-number">M${i}</span><span class="month-date">${monthStr}</span>`;

            monthHeaderRow.appendChild(th);
        }

        // Reinitialize all cells with new month count
        initializeCashflowCells();
        updateAllCashflow();
    }

    // Initialize month header row
    function initializeMonthHeaders() {
        const monthHeaderRow = document.getElementById('monthHeaderRow');
        const startDateInput = document.getElementById('start_date');
        const startDate = startDateInput && startDateInput.value ? new Date(startDateInput.value) : new Date();

        for (let i = 0; i < NUM_MONTHS; i++) {
            const th = document.createElement('th');
            th.className = 'text-center month-header';
            th.style.minWidth = '70px';

            // Calculate month date
            const monthDate = new Date(startDate);
            monthDate.setMonth(monthDate.getMonth() + i);
            const monthStr = monthDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });

            // Create HTML with month number and date
            th.innerHTML = `<span class="month-number">M${i}</span><span class="month-date">${monthStr}</span>`;

            monthHeaderRow.appendChild(th);
        }
    }

    // Initialize cashflow cells for each row
    function initializeCashflowCells() {
        const rows = document.querySelectorAll('.cashflow-row');
        rows.forEach(row => {
            // Remove existing cashflow cells
            const existingCells = row.querySelectorAll('.cashflow-cell');
            existingCells.forEach(cell => cell.remove());

            // Create new cells based on current NUM_MONTHS
            for (let i = 0; i < NUM_MONTHS; i++) {
                const td = document.createElement('td');
                td.className = 'text-end cashflow-cell';
                td.setAttribute('data-month', i);
                td.textContent = '0';
                td.style.fontSize = '0.7rem';
                td.style.backgroundColor = '#f8f9fa';
                td.style.padding = '0.2rem 0.4rem';
                row.appendChild(td);
            }
        });
    }

    // S-Curve distribution function
    function getSCurveDistribution(totalAmount, span) {
        // Returns array of monthly values following an S-curve pattern
        const distribution = [];
        const weights = [];

        // Generate S-curve weights using cumulative normal distribution approximation
        for (let i = 0; i < span; i++) {
            const x = (i / (span - 1) - 0.5) * 6; // Map to -3 to +3
            const weight = 1 / (1 + Math.exp(-x * 1.5)); // Sigmoid function
            weights.push(weight);
        }

        // Calculate differences to get monthly values
        const monthlyWeights = [weights[0]];
        for (let i = 1; i < span; i++) {
            monthlyWeights.push(weights[i] - weights[i-1]);
        }

        // Normalize and multiply by total amount
        const sum = monthlyWeights.reduce((a, b) => a + b, 0);
        return monthlyWeights.map(w => (w / sum) * totalAmount);
    }

    // Helper: Generate linear distribution
    function generateLinear(span) {
        return Array(span).fill(1 / span);
    }

    // Helper: Generate S-curve distribution
    function generateSCurve(span) {
        const weights = [];
        for (let i = 0; i < span; i++) {
            const t = i / (span - 1);
            const sCurve = 1 / (1 + Math.exp(-10 * (t - 0.5)));
            weights.push(sCurve);
        }

        const monthlyWeights = [weights[0]];
        for (let i = 1; i < span; i++) {
            monthlyWeights.push(weights[i] - weights[i-1]);
        }

        // Normalize
        const sum = monthlyWeights.reduce((a, b) => a + b, 0);
        return monthlyWeights.map(w => w / sum);
    }

    // Update all cashflow rows (skips calculated and static rows)
    function updateAllCashflow() {
        const rows = document.querySelectorAll('.cashflow-row:not([data-is-calculated="true"]):not([data-is-static="true"])');
        rows.forEach(updateRowCashflow);

        // After updating regular rows, update calculated summary rows
        updateTDCCashflow();
        updateNetRevenue(); // Calculate net revenue and generate its cashflow
        updateProjectCashflow(); // Project CF uses net revenue
        updateWaterfallFinancing(); // Calculate equity and senior loan cashflows
    }

    // Update TDC monthly cashflow (sum of all cost rows per month)
    function updateTDCCashflow() {
        const tdcRow = document.querySelector('[data-item="tdc_subtotal"]');
        if (!tdcRow) return;

        const cells = tdcRow.querySelectorAll('.cashflow-cell');

        // Calculate monthly totals
        for (let month = 0; month < NUM_MONTHS; month++) {
            let monthlyTotal = 0;

            // Sum all cost rows for this month (excluding revenue and calculated rows)
            document.querySelectorAll('.cashflow-row:not([data-is-revenue="true"]):not([data-is-calculated="true"])').forEach(row => {
                const monthCell = row.querySelector(`[data-month="${month}"]`);
                if (monthCell) {
                    const text = monthCell.textContent.replace(/[(),]/g, '');
                    monthlyTotal += parseFloat(text) || 0;
                }
            });

            // Update TDC cell
            const tdcCell = cells[month];
            if (tdcCell && monthlyTotal !== 0) {
                const formatted = Math.abs(monthlyTotal).toLocaleString('en-AU', {maximumFractionDigits: 0});
                tdcCell.textContent = `(${formatted})`;
                tdcCell.classList.add('cell-neutral'); tdcCell.style.backgroundColor = '';
                tdcCell.style.fontWeight = '600';
            } else if (tdcCell) {
                tdcCell.textContent = '0';
                tdcCell.classList.add('cell-neutral'); tdcCell.style.backgroundColor = '';
                tdcCell.style.fontWeight = '600';
            }
        }

        // Update TDC display
        updateTDCDisplay();
    }

    // Update Project Cashflow monthly (net revenue minus all costs per month)
    function updateProjectCashflow() {
        const projRow = document.querySelector('[data-item="project_cashflow"]');
        if (!projRow) return;

        const cells = projRow.querySelectorAll('.cashflow-cell');
        const netRevRow = document.querySelector('[data-item="net_revenue"]');

        if (!netRevRow) return;

        const netRevCells = netRevRow.querySelectorAll('.cashflow-cell');

        // Calculate monthly project cashflow
        for (let month = 0; month < NUM_MONTHS; month++) {
            let monthlyNetRevenue = 0;
            let monthlyCosts = 0;

            // Get net revenue for this month
            const netRevCell = netRevCells[month];
            if (netRevCell) {
                const text = netRevCell.textContent.replace(/[(),]/g, '');
                monthlyNetRevenue = parseFloat(text) || 0;
            }

            // Sum costs for this month (excluding revenue, revenue deductions, and calculated rows)
            document.querySelectorAll('.cashflow-row:not([data-is-revenue="true"]):not([data-is-revenue-deduction="true"]):not([data-is-calculated="true"]):not([data-is-net-revenue="true"])').forEach(row => {
                const monthCell = row.querySelector(`[data-month="${month}"]`);
                if (monthCell) {
                    const text = monthCell.textContent.replace(/[(),]/g, '');
                    monthlyCosts += parseFloat(text) || 0;
                }
            });

            const netCashflow = monthlyNetRevenue - monthlyCosts;

            // Update Project Cashflow cell
            const projCell = cells[month];
            if (projCell) {
                if (netCashflow !== 0) {
                    const formatted = Math.abs(netCashflow).toLocaleString('en-AU', {maximumFractionDigits: 0});
                    projCell.textContent = netCashflow >= 0 ? formatted : `(${formatted})`;
                    projCell.classList.remove('cell-positive', 'cell-negative'); projCell.classList.add(netCashflow >= 0 ? 'cell-positive' : 'cell-negative');
                    projCell.style.fontWeight = '600';
                } else {
                    projCell.textContent = '0';
                    projCell.classList.add('cell-neutral');
                    projCell.style.fontWeight = '600';
                }
            }
        }
    }

    // Calculate Waterfall Financing (Equity first, then Senior Loan)
    function updateWaterfallFinancing() {
        // Get financing parameters
        const equityLimit = parseInputFloat(document.getElementById('equity_max_limit').value);
        const equityRate = parseInputFloat(document.getElementById('equity_interest_rate').value);
        const loanLimit = parseInputFloat(document.getElementById('loan_max_limit').value);
        const loanRate = parseInputFloat(document.getElementById('loan_interest_rate').value);

        // Find construction start month (from construction_cost row)
        const constructionStartInput = document.getElementById('construction_cost_start');
        const constructionStart = constructionStartInput ? parseInt(constructionStartInput.value) || 4 : 4;

        // Get project cashflow for each month from cells
        const projectCashflows = [];
        const projRow = document.querySelector('[data-item="project_cashflow"]');
        if (projRow) {
            const cells = projRow.querySelectorAll('.cashflow-cell');
            for (let month = 0; month < NUM_MONTHS; month++) {
                const cell = cells[month];
                if (cell) {
                    const text = cell.textContent.trim().replace(/,/g, '');
                    let value = 0;
                    if (text && text !== '0' && text !== '') {
                        // Check if negative (in parentheses)
                        if (text.includes('(') || text.includes(')')) {
                            value = -Math.abs(parseFloat(text.replace(/[()]/g, '')));
                        } else {
                            value = parseFloat(text);
                        }
                    }
                    projectCashflows.push(value || 0);
                } else {
                    projectCashflows.push(0);
                }
            }
        }

        // Debug: Log project cashflows
        const hasRevenue = projectCashflows.some(cf => cf > 0);
        console.log('Project cashflows - Has revenue:', hasRevenue, 'Total months:', projectCashflows.length);

        // Initialize balances
        let equityBalance = 0;
        let loanBalance = 0;
        const equityData = {
            opening: [],
            drawdown: [],
            interest: [],
            repayment: [],
            closing: []
        };
        const loanData = {
            opening: [],
            drawdown: [],
            interest: [],
            repayment: [],
            closing: []
        };

        // Process each month
        for (let month = 0; month < NUM_MONTHS; month++) {
            const projectCF = projectCashflows[month];

            // EQUITY CALCULATIONS
            // Opening balance = previous month's closing (or 0 for month 0)
            if (month === 0) {
                equityData.opening[month] = 0;
                equityBalance = 0;
            } else {
                equityData.opening[month] = equityData.closing[month - 1];
                equityBalance = equityData.opening[month];
            }

            // SENIOR LOAN CALCULATIONS - Opening balance
            if (month === 0) {
                loanData.opening[month] = 0;
                loanBalance = 0;
            } else {
                loanData.opening[month] = loanData.closing[month - 1];
                loanBalance = loanData.opening[month];
            }

            // FINANCING WATERFALL LOGIC
            if (month < constructionStart) {
                // BEFORE CONSTRUCTION: Equity funds everything
                if (projectCF < 0) {
                    const requiredFunding = Math.abs(projectCF);
                    const availableEquity = equityLimit - equityBalance;
                    const equityDraw = Math.min(requiredFunding, availableEquity);
                    equityData.drawdown[month] = equityDraw;
                    equityBalance += equityDraw;
                } else {
                    equityData.drawdown[month] = 0;
                }
                equityData.repayment[month] = 0;
                loanData.drawdown[month] = 0;
                loanData.repayment[month] = 0;

            } else {
                // AFTER CONSTRUCTION START: Equity continues until limit, then senior loan

                if (projectCF < 0) {
                    // COSTS: Use equity first to limit, then senior loan
                    const requiredFunding = Math.abs(projectCF);

                    // Try equity first up to limit
                    const availableEquity = equityLimit - equityBalance;
                    const equityDraw = Math.min(requiredFunding, availableEquity);
                    equityData.drawdown[month] = equityDraw;
                    equityBalance += equityDraw;

                    // If equity limit reached, use senior loan for remainder
                    const remainingNeed = requiredFunding - equityDraw;
                    if (remainingNeed > 0) {
                        const availableLoan = loanLimit - loanBalance;
                        const loanDraw = Math.min(remainingNeed, availableLoan);
                        loanData.drawdown[month] = loanDraw;
                        loanBalance += loanDraw;
                    } else {
                        loanData.drawdown[month] = 0;
                    }

                    loanData.repayment[month] = 0;
                    equityData.repayment[month] = 0;

                } else if (projectCF > 0) {
                    // REVENUE: Repay senior loan first, then equity capital, remainder is profit
                    const availableCash = projectCF;

                    equityData.drawdown[month] = 0;
                    loanData.drawdown[month] = 0;

                    // Repay senior loan first (balance can't go below 0)
                    const loanRepay = Math.min(availableCash, loanBalance);
                    loanData.repayment[month] = loanRepay;
                    loanBalance -= loanRepay;

                    // Remaining cash goes to equity
                    const remainingCash = availableCash - loanRepay;

                    // Repay equity capital first (balance can't go below 0)
                    const equityCapitalRepayment = Math.min(remainingCash, equityBalance);
                    equityBalance -= equityCapitalRepayment;

                    // Total repayment to equity includes capital repayment + profit distribution
                    // (all remaining cash goes to equity investors)
                    equityData.repayment[month] = remainingCash;

                    // Debug logging
                    if (remainingCash > 0) {
                        console.log(`Month ${month}: Revenue=${projectCF}, LoanRepay=${loanRepay}, EquityRepay=${remainingCash}, EquityBalance after=${equityBalance}`);
                    }

                } else {
                    // No cashflow
                    equityData.drawdown[month] = 0;
                    equityData.repayment[month] = 0;
                    loanData.drawdown[month] = 0;
                    loanData.repayment[month] = 0;
                }
            }

            // Calculate interest (capitalizes monthly)
            if (equityBalance > 0) {
                const monthlyInterest = equityBalance * (equityRate / 100 / 12);
                equityData.interest[month] = monthlyInterest;
                equityBalance += monthlyInterest;
            } else {
                equityData.interest[month] = 0;
            }

            equityData.closing[month] = equityBalance;

            // SENIOR LOAN - Calculate interest and closing
            if (loanBalance > 0) {
                const monthlyInterest = loanBalance * (loanRate / 100 / 12);
                loanData.interest[month] = monthlyInterest;
                loanBalance += monthlyInterest;
            } else {
                loanData.interest[month] = 0;
            }

            loanData.closing[month] = loanBalance;
        }

        // Update equity rows
        updateFinancingRow('equity_opening', equityData.opening, false);
        updateFinancingRow('equity_drawdown', equityData.drawdown, false);
        updateFinancingRow('equity_interest', equityData.interest, false);
        updateFinancingRow('equity_repayment', equityData.repayment, true);

        // Equity cashflow: from investor perspective
        // Calculate monthly cashflows first
        const monthlyEquityCF = equityData.opening.map((_, i) =>
            -(equityData.drawdown[i] || 0) - (equityData.interest[i] || 0) + (equityData.repayment[i] || 0)
        );

        // Update monthly equity cashflow row
        updateFinancingRow('equity_cashflow_monthly', monthlyEquityCF, null);

        // Convert to cumulative
        const cumulativeEquityCF = [];
        let cumulative = 0;
        for (let i = 0; i < monthlyEquityCF.length; i++) {
            cumulative += monthlyEquityCF[i];
            cumulativeEquityCF.push(cumulative);
        }

        // Update cumulative equity cashflow row
        updateFinancingRow('equity_cashflow', cumulativeEquityCF, null);

        // Update senior loan rows
        updateFinancingRow('loan_opening', loanData.opening, false);
        updateFinancingRow('loan_drawdown', loanData.drawdown, false);
        updateFinancingRow('loan_interest', loanData.interest, false);
        updateFinancingRow('loan_repayment', loanData.repayment, true);

        // Loan cashflow: CUMULATIVE from lender perspective
        // Calculate monthly cashflows first
        const monthlyLoanCF = loanData.opening.map((_, i) =>
            -(loanData.drawdown[i] || 0) - (loanData.interest[i] || 0) + (loanData.repayment[i] || 0)
        );

        // Convert to cumulative
        const cumulativeLoanCF = [];
        let cumulativeLoan = 0;
        for (let i = 0; i < monthlyLoanCF.length; i++) {
            cumulativeLoan += monthlyLoanCF[i];
            cumulativeLoanCF.push(cumulativeLoan);
        }

        updateFinancingRow('loan_cashflow', cumulativeLoanCF, null);

        // Calculate development metrics
        const tdc = calculateTDC();
        const netRevenue = calculateNetRevenue();

        // UNLEVERED METRICS (before financing)
        const developmentProfit = netRevenue - tdc; // Unlevered development profit
        const developmentMargin = tdc > 0 ? (developmentProfit / tdc) * 100 : 0;

        // LEVERED METRICS (equity investor returns after financing)
        const totalEquityInvested = equityData.drawdown.reduce((sum, val) => sum + (val || 0), 0);
        const totalEquityReturned = equityData.repayment.reduce((sum, val) => sum + (val || 0), 0);
        const equityProfit = totalEquityReturned - totalEquityInvested; // Levered equity profit

        // Calculate peak funding (maximum combined equity + loan balance)
        let peakFunding = 0;
        for (let month = 0; month < NUM_MONTHS; month++) {
            const totalOutstanding = (equityData.closing[month] || 0) + (loanData.closing[month] || 0);
            if (totalOutstanding > peakFunding) {
                peakFunding = totalOutstanding;
            }
        }

        // Calculate IRR on project cashflows (unlevered)
        const projectIRR = calculateIRR(projectCashflows);

        // Calculate IRR on equity cashflows (levered)
        const equityIRR = calculateIRR(monthlyEquityCF);

        // Update summary metrics display
        updateDevelopmentMetrics(developmentProfit, developmentMargin, equityProfit, projectIRR, equityIRR, peakFunding);
    }

    // Calculate IRR using Newton-Raphson method
    // Format number with commas
    function formatCurrency(value) {
        return '$' + Math.round(value).toLocaleString('en-AU');
    }

    // Calculate NPV
    function calculateNPV(cashflows, discountRate) {
        let npv = 0;
        for (let i = 0; i < cashflows.length; i++) {
            npv += cashflows[i] / Math.pow(1 + discountRate/12, i);
        }
        return npv;
    }

    // Store solved land value for Apply button
    let solvedLandValue = null;

    // Solve for land value to achieve target IRR
    function solveLandForIRR() {
        const targetIRR = parseFloat(document.getElementById('target_irr').value) / 100;
        const currentLandPrice = parseFloat(document.getElementById('purchase_price').value) || 0;

        // Binary search for land value
        let lowLand = 0;
        let highLand = currentLandPrice * 3;
        let iterations = 0;
        const maxIterations = 50;
        const tolerance = 0.001;

        while (iterations < maxIterations) {
            const midLand = (lowLand + highLand) / 2;

            // Temporarily set land price and recalculate
            const originalValue = document.getElementById('purchase_price').value;
            document.getElementById('purchase_price').value = midLand;

            // Trigger recalculation
            const result = calculateProjectCashflows();
            const testIRR = result.projectIRR;

            // Restore original
            document.getElementById('purchase_price').value = originalValue;

            if (testIRR === null || isNaN(testIRR)) {
                document.getElementById('solved_land_value').textContent = 'Unable to solve';
                document.getElementById('apply_land_btn').classList.add('d-none');
                solvedLandValue = null;
                return;
            }

            if (Math.abs(testIRR - targetIRR) < tolerance) {
                solvedLandValue = midLand;
                document.getElementById('solved_land_value').textContent =
                    formatCurrency(midLand) + ' for ' + (targetIRR * 100).toFixed(1) + '% IRR';
                document.getElementById('apply_land_btn').classList.remove('d-none');
                // Trigger full recalculation to restore state
                calculateAll();
                return;
            }

            // IRR increases as land price decreases
            if (testIRR < targetIRR) {
                highLand = midLand;
            } else {
                lowLand = midLand;
            }

            iterations++;
        }

        document.getElementById('solved_land_value').textContent = 'Could not converge';
        document.getElementById('apply_land_btn').classList.add('d-none');
        solvedLandValue = null;
        calculateAll();
    }

    // Apply the solved land value to the model
    function applyLandValue() {
        if (solvedLandValue !== null) {
            document.getElementById('purchase_price').value = Math.round(solvedLandValue);
            document.getElementById('apply_land_btn').classList.add('d-none');
            document.getElementById('solved_land_value').textContent = 'Applied!';
            setTimeout(() => {
                document.getElementById('solved_land_value').textContent = '';
            }, 2000);
            calculateAll();
        }
    }

    // Helper to get project cashflows for solving
    function calculateProjectCashflows() {
        // This will be called during solve - simplified version
        const gdv = parseFloat(document.getElementById('gdv').value) || 0;
        const purchasePrice = parseFloat(document.getElementById('purchase_price').value) || 0;

        // Calculate total costs
        let totalCosts = purchasePrice;
        document.querySelectorAll('.cashflow-input').forEach(input => {
            if (input.id !== 'gdv' && input.id !== 'purchase_price') {
                totalCosts += parseFloat(input.value) || 0;
            }
        });

        // Simple monthly cashflow approximation
        const projectMonths = parseInt(document.getElementById('project_months')?.value) || 24;
        const cashflows = new Array(projectMonths).fill(0);
        cashflows[0] = -purchasePrice;

        // Spread costs
        const otherCosts = totalCosts - purchasePrice;
        const constructionMonths = Math.floor(projectMonths * 0.7);
        for (let i = 1; i <= constructionMonths; i++) {
            cashflows[i] = -otherCosts / constructionMonths;
        }

        // Revenue at end
        cashflows[projectMonths - 1] += gdv;

        const projectIRR = calculateIRR(cashflows);
        return { projectIRR, cashflows };
    }

    function calculateIRR(cashflows, guess = 0.1) {
        if (!cashflows || cashflows.length === 0) return null;

        const maxIterations = 1000;
        const tolerance = 0.00001;

        // Filter out leading zeros to find first non-zero cashflow
        let firstNonZero = 0;
        for (let i = 0; i < cashflows.length; i++) {
            if (Math.abs(cashflows[i]) > 0.01) {
                firstNonZero = i;
                break;
            }
        }

        // Check if there are any cashflows
        const hasOutflow = cashflows.some(cf => cf < -0.01);
        const hasInflow = cashflows.some(cf => cf > 0.01);
        if (!hasOutflow || !hasInflow) return null;

        let rate = guess / 12; // Start with monthly rate

        for (let iter = 0; iter < maxIterations; iter++) {
            let npv = 0;
            let dnpv = 0;

            for (let t = firstNonZero; t < cashflows.length; t++) {
                const period = t - firstNonZero;
                if (rate === -1) rate = -0.99; // Prevent division by zero

                const discount = Math.pow(1 + rate, period);
                npv += cashflows[t] / discount;

                if (period > 0) {
                    dnpv -= period * cashflows[t] / (discount * (1 + rate));
                }
            }

            // Check for convergence
            if (Math.abs(npv) < tolerance) {
                return rate * 12; // Convert monthly to annual IRR
            }

            // Check derivative
            if (Math.abs(dnpv) < 1e-10) {
                // Try a different starting point
                if (iter === 0) {
                    rate = 0.01;
                    continue;
                }
                break;
            }

            // Newton-Raphson step
            const newRate = rate - npv / dnpv;

            // Prevent extreme values
            if (newRate < -0.99) {
                rate = -0.99;
            } else if (newRate > 5) {
                rate = 5;
            } else {
                rate = newRate;
            }
        }

        return rate * 12; // Convert monthly to annual IRR
    }

    // Update development metrics display
    function updateDevelopmentMetrics(devProfit, margin, equityProfit, projectIRR, equityIRR, peakFunding) {
        // Calculate additional metrics
        const purchasePrice = parseFloat(document.getElementById('purchase_price').value) || 0;
        const npv = calculateNPV(projectCashflows, 0.10);
        const roe = equityRequired > 0 ? (equityProfit / equityRequired) * 100 : 0;

        // Format values
        const devProfitText = formatCurrency(devProfit);
        const marginText = margin.toFixed(1) + '%';
        const equityProfitText = formatCurrency(equityProfit);
        const projectIRRText = (projectIRR !== null && !isNaN(projectIRR)) ? (projectIRR * 100).toFixed(1) + '%' : 'N/A';
        const equityIRRText = (equityIRR !== null && !isNaN(equityIRR)) ? (equityIRR * 100).toFixed(1) + '%' : 'N/A';
        const peakFundingText = formatCurrency(peakFunding);
        const tdcText = formatCurrency(tdc);
        const npvText = formatCurrency(npv);
        const roeText = roe.toFixed(1) + '%';
        const landPriceText = formatCurrency(purchasePrice);

        // Update sticky summary bar
        const updateSticky = (id, text, value) => {
            const elem = document.getElementById(id);
            if (elem) {
                elem.textContent = text;
                if (value !== undefined) {
                    elem.style.color = value >= 0 ? 'var(--success))' : 'var(--danger))';
                }
            }
        };

        updateSticky('summary_dev_profit_sticky', devProfitText, devProfit);
        updateSticky('summary_margin_sticky', marginText, margin);
        updateSticky('summary_irr_sticky', projectIRRText, projectIRR);
        updateSticky('summary_equity_profit_sticky', equityProfitText, equityProfit);
        updateSticky('summary_equity_irr_sticky', equityIRRText, equityIRR);
        updateSticky('summary_peak_funding_sticky', peakFundingText);

        // Update collapsible summary cards
        const devProfitElement = document.getElementById('summary_dev_profit');
        const marginElement = document.getElementById('summary_margin');
        const equityProfitElement = document.getElementById('summary_equity_profit');
        const projectIRRElement = document.getElementById('summary_irr');
        const equityIRRElement = document.getElementById('summary_equity_irr');
        const peakFundingElement = document.getElementById('summary_peak_funding');

        if (devProfitElement) {
            devProfitElement.textContent = devProfitText;
            devProfitElement.style.color = devProfit >= 0 ? 'var(--success))' : 'var(--danger))';
        }
        if (marginElement) {
            marginElement.textContent = marginText;
            marginElement.style.color = margin >= 0 ? 'var(--success))' : 'var(--danger))';
        }
        if (equityProfitElement) {
            equityProfitElement.textContent = equityProfitText;
            equityProfitElement.style.color = equityProfit >= 0 ? 'var(--success))' : 'var(--danger))';
        }
        if (projectIRRElement) {
            projectIRRElement.textContent = projectIRRText;
            if (projectIRR !== null && !isNaN(projectIRR)) {
                projectIRRElement.style.color = projectIRR >= 0 ? 'var(--success))' : 'var(--danger))';
            } else {
                projectIRRElement.style.color = '#6c757d';
            }
        }
        if (equityIRRElement) {
            equityIRRElement.textContent = equityIRRText;
            if (equityIRR !== null && !isNaN(equityIRR)) {
                equityIRRElement.style.color = equityIRR >= 0 ? 'var(--success))' : 'var(--danger))';
            } else {
                equityIRRElement.style.color = '#6c757d';
            }
        }
        if (peakFundingElement) {
            peakFundingElement.textContent = peakFundingText;
        }

        // Update new metric elements
        const tdcElement = document.getElementById('summary_tdc');
        const npvElement = document.getElementById('summary_npv');
        const roeElement = document.getElementById('summary_roe');
        const landPriceElement = document.getElementById('summary_land_price');

        if (tdcElement) tdcElement.textContent = tdcText;
        if (npvElement) {
            npvElement.textContent = npvText;
            npvElement.style.color = npv >= 0 ? 'var(--success)' : 'var(--danger)';
        }
        if (roeElement) {
            roeElement.textContent = roeText;
            roeElement.style.color = roe >= 0 ? 'var(--success)' : 'var(--danger)';
        }
        if (landPriceElement) landPriceElement.textContent = landPriceText;
    }

    // Update a financing row with calculated values
    function updateFinancingRow(itemId, values, isRevenue) {
        const row = document.querySelector(`[data-item="${itemId}"]`);
        if (!row) return;

        const cells = row.querySelectorAll('.cashflow-cell');
        values.forEach((value, month) => {
            const cell = cells[month];
            if (!cell) return;

            if (value !== 0 && Math.abs(value) > 0.01) {
                const formatted = Math.abs(value).toLocaleString('en-AU', {maximumFractionDigits: 0});

                if (isRevenue === null) {
                    // Cashflow rows: negative is outflow (red), positive is inflow (green)
                    cell.textContent = value >= 0 ? formatted : `(${formatted})`;
                    cell.style.backgroundColor = value >= 0 ? '#d4edda' : '#f8d7da';
                } else if (isRevenue) {
                    // Revenue-like (repayments)
                    cell.textContent = formatted;
                    cell.classList.add('cell-positive'); cell.style.backgroundColor = '';
                } else {
                    // Cost-like (drawdowns, interest)
                    cell.textContent = `(${formatted})`;
                    cell.classList.add('cell-negative'); cell.style.backgroundColor = '';
                }
                cell.style.fontWeight = '500';
            } else {
                cell.textContent = '0';
                cell.style.backgroundColor = '#f8f9fa';
                cell.style.fontWeight = 'normal';
            }
        });
    }

    // Get project area/unit metrics
    function getProjectMetrics() {
        return {
            gfa: parseFloat(document.getElementById('gfa').value) || 0,
            nsa: parseFloat(document.getElementById('nsa').value) || 0,
            gba: parseFloat(document.getElementById('gba').value) || 0,
            units: parseFloat(document.getElementById('num_units').value) || 0
        };
    }

    // Calculate Total Development Cost (TDC)
    function calculateTDC() {
        let total = 0;
        // Sum all cost rows (excluding revenue and financing)
        document.querySelectorAll('.cashflow-row:not([data-is-revenue="true"]):not([data-is-calculated="true"]):not([data-is-revenue-deduction="true"])').forEach(row => {
            const itemId = row.getAttribute('data-item');
            const amountInput = document.getElementById(itemId);
            if (amountInput) {
                total += parseFloat(amountInput.value) || 0;
            }
        });
        return total;
    }

    // Calculate Gross Development Value (GDV)
    function calculateGDV() {
        const gdvInput = document.getElementById('gdv');
        return gdvInput ? parseFloat(gdvInput.value) || 0 : 0;
    }

    // Calculate Net Revenue
    function calculateNetRevenue() {
        const gdv = calculateGDV();
        const sellingCosts = parseFloat(document.getElementById('selling_costs')?.value) || 0;
        const gstOnSale = parseFloat(document.getElementById('gst_on_sale')?.value) || 0;
        const agentCommissions = parseFloat(document.getElementById('agent_commissions')?.value) || 0;

        return gdv - sellingCosts - gstOnSale - agentCommissions;
    }

    // Update Net Revenue total and display
    function updateNetRevenue() {
        const gdv = calculateGDV();
        const sellingCosts = parseFloat(document.getElementById('selling_costs')?.value) || 0;
        const gstOnSale = parseFloat(document.getElementById('gst_on_sale')?.value) || 0;
        const agentCommissions = parseFloat(document.getElementById('agent_commissions')?.value) || 0;

        const netRevenue = gdv - sellingCosts - gstOnSale - agentCommissions;

        // Update display
        const displayElem = document.getElementById('net_revenue_display');
        if (displayElem) {
            displayElem.textContent = '$' + Math.round(netRevenue).toLocaleString('en-AU');
            displayElem.style.fontWeight = '600';
            displayElem.style.color = netRevenue >= 0 ? '#198754' : '#dc3545';
        }

        // Generate cashflow for net revenue based on timing (like any other revenue row)
        updateRowCashflow(document.querySelector('[data-item="net_revenue"]'));
    }

    // Update a single row's cashflow based on its timing parameters
    function updateRowCashflow(row) {
        if (!row) return;

        const itemId = row.getAttribute('data-item');
        if (!itemId) return;

        // Skip calculated rows (they're updated separately)
        if (row.getAttribute('data-is-calculated') === 'true' && itemId !== 'net_revenue') return;

        // Skip static rows (no timing)
        if (row.getAttribute('data-is-static') === 'true') return;

        const cells = row.querySelectorAll('.cashflow-cell');
        if (!cells.length) return;

        let amount;
        if (itemId === 'net_revenue') {
            // Get the calculated net revenue value
            amount = calculateNetRevenue();
        } else {
            // Get amount from input
            const amountInput = document.getElementById(itemId);
            amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
        }

        const startInput = document.getElementById(itemId + '_start');
        const spanInput = document.getElementById(itemId + '_span');
        const scurveCheckbox = document.getElementById(itemId + '_scurve');

        const start = startInput ? parseInt(startInput.value) || 0 : 0;
        const span = spanInput ? parseInt(spanInput.value) || 1 : 1;
        const useSCurve = scurveCheckbox ? scurveCheckbox.checked : false;

        const isRevenue = row.getAttribute('data-is-revenue') === 'true';

        // Distribute amount across months
        const distribution = useSCurve ? generateSCurve(span) : generateLinear(span);

        cells.forEach((cell, month) => {
            let value = 0;

            if (month >= start && month < start + span) {
                const distIndex = month - start;
                value = amount * distribution[distIndex];
            }

            // Format and display
            if (value !== 0) {
                const formatted = Math.abs(value).toLocaleString('en-AU', {maximumFractionDigits: 0});
                cell.textContent = value >= 0 ? formatted : `(${formatted})`;
                cell.style.backgroundColor = isRevenue ? '#d4edda' : '#f8d7da';
            } else {
                cell.textContent = '';
                cell.style.backgroundColor = 'transparent';
            }

            cell.setAttribute('data-month', month);
        });
    }

    // Bidirectional: Rate ‚Üí Amount
    function updateAmountFromRate(itemId) {
        const amountInput = document.getElementById(itemId);
        const rateInput = document.getElementById(itemId + '_rate');
        const metricSelect = document.getElementById(itemId + '_metric');

        if (!amountInput || !rateInput || !metricSelect) return;

        const rate = parseFloat(rateInput.value) || 0;
        const metric = metricSelect.value;
        const metrics = getProjectMetrics();

        let amount = 0;

        switch(metric) {
            case 'per_gfa':
                amount = rate * metrics.gfa;
                break;
            case 'per_nsa':
                amount = rate * metrics.nsa;
                break;
            case 'per_gba':
                amount = rate * metrics.gba;
                break;
            case 'per_unit':
                amount = rate * metrics.units;
                break;
            case 'pct_tdc':
                amount = (rate / 100) * calculateTDC();
                break;
            case 'pct_gdv':
                amount = (rate / 100) * calculateGDV();
                break;
            case 'amount':
            default:
                return; // No calculation needed for amount mode
        }

        amountInput.value = Math.round(amount);
    }

    // Bidirectional: Amount ‚Üí Rate
    function updateRateFromAmount(itemId) {
        const amountInput = document.getElementById(itemId);
        const rateInput = document.getElementById(itemId + '_rate');
        const metricSelect = document.getElementById(itemId + '_metric');

        if (!amountInput || !rateInput || !metricSelect) return;

        const amount = parseFloat(amountInput.value) || 0;
        const metric = metricSelect.value;
        const metrics = getProjectMetrics();

        let rate = 0;

        switch(metric) {
            case 'per_gfa':
                rate = metrics.gfa > 0 ? amount / metrics.gfa : 0;
                break;
            case 'per_nsa':
                rate = metrics.nsa > 0 ? amount / metrics.nsa : 0;
                break;
            case 'per_gba':
                rate = metrics.gba > 0 ? amount / metrics.gba : 0;
                break;
            case 'per_unit':
                rate = metrics.units > 0 ? amount / metrics.units : 0;
                break;
            case 'pct_tdc':
                const tdc = calculateTDC();
                rate = tdc > 0 ? (amount / tdc) * 100 : 0;
                break;
            case 'pct_gdv':
                const gdv = calculateGDV();
                rate = gdv > 0 ? (amount / gdv) * 100 : 0;
                break;
            case 'amount':
            default:
                rateInput.value = '';
                return;
        }

        rateInput.value = rate.toFixed(2);
    }

    // LVR/LTC Calculator
    function updateLoanFromCalculator() {
        const method = document.getElementById('loan_calc_method').value;
        const pct = parseFloat(document.getElementById('loan_calc_pct').value) || 0;
        const loanInput = document.getElementById('loan_max_limit');
        const resultSpan = document.getElementById('loan_calc_result');

        let loanAmount = 0;

        if (method === 'lvr') {
            // LVR = Loan / GDV
            const gdv = parseInputFloat(document.getElementById('gdv').value);
            loanAmount = (pct / 100) * gdv;
        } else if (method === 'ltc') {
            // LTC = Loan / TDC
            const tdc = calculateTDC();
            loanAmount = (pct / 100) * tdc;
        } else {
            // Manual mode - don't update
            resultSpan.textContent = 'Manual';
            return;
        }

        // Set the loan amount (without formatting to allow proper saving)
        loanInput.value = Math.round(loanAmount);
        resultSpan.textContent = '$' + Math.round(loanAmount).toLocaleString('en-AU');
    }

    // Update TDC Display
    function updateTDCDisplay() {
        const tdc = calculateTDC();
        document.getElementById('tdc_display').textContent = '$' + Math.round(tdc).toLocaleString('en-AU');
    }

    // Update Equity from % Input
    function updateEquityFromPercentage() {
        const pct = parseFloat(document.getElementById('equity_pct_input').value) || 0;
        const tdc = calculateTDC();
        const equityLimit = (pct / 100) * tdc;

        document.getElementById('equity_max_limit').value = Math.round(equityLimit);
        document.getElementById('equity_limit_calc').textContent = '$' + Math.round(equityLimit).toLocaleString('en-AU');
    }

    // Stamp Duty Calculator (UK SDLT rates as example)
    function calculateStampDuty() {
        const purchasePrice = parseFloat(document.getElementById('purchase_price').value) || 0;
        let stampDuty = 0;

        // Simplified UK SDLT rates for residential property
        if (purchasePrice <= 250000) {
            stampDuty = 0;
        } else if (purchasePrice <= 925000) {
            stampDuty = (purchasePrice - 250000) * 0.05;
        } else if (purchasePrice <= 1500000) {
            stampDuty = 33750 + (purchasePrice - 925000) * 0.10;
        } else {
            stampDuty = 91250 + (purchasePrice - 1500000) * 0.12;
        }

        document.getElementById('stamp_duty').value = Math.round(stampDuty);

        // Trigger rate calculation
        updateRateFromAmount('stamp_duty');

        // Update cashflow display
        const row = document.querySelector('[data-item="stamp_duty"]');
        if (row) {
            updateRowCashflow(row);
        }

        // Update calculations
        updateTDCDisplay();
        updateLoanFromCalculator();
        updateEquityFromPercentage();
    }

    // Add Custom Row to a Section
    let customRowCounter = 0;
    function addCustomRow(section) {
        customRowCounter++;
        const rowId = `custom_${section}_${customRowCounter}`;

        const newRow = document.createElement('tr');
        newRow.className = 'cashflow-row';
        newRow.setAttribute('data-item', rowId);
        newRow.innerHTML = `
            <td style="position: sticky; left: 0; background: var(--bg-primary); z-index: 10;">
                <input type="text" class="form-control form-control-sm" placeholder="Custom Item" style="width: 140px;">
                <button type="button" class="btn btn-sm btn-link p-0 text-danger" onclick="this.closest('tr').remove(); updateAllCashflow();" title="Remove">√ó</button>
            </td>
            <td><input type="number" class="form-control form-control-sm cashflow-input" id="${rowId}" value="0"></td>
            <td><select class="form-select form-select-sm metric-select" id="${rowId}_metric" data-item="${rowId}">
                <option value="amount">Amount</option>
                <option value="per_gfa">$/GFA</option>
                <option value="per_nsa">$/NSA</option>
                <option value="per_gba">$/GBA</option>
                <option value="per_unit">$/Unit</option>
                <option value="pct_tdc">% TDC</option>
            </select></td>
            <td><input type="number" class="form-control form-control-sm rate-input" id="${rowId}_rate" step="0.01"></td>
            <td><input type="number" class="form-control form-control-sm" id="${rowId}_start" value="0" min="0"></td>
            <td><input type="number" class="form-control form-control-sm" id="${rowId}_span" value="1" min="1"></td>
            <td class="text-center"><input type="checkbox" class="form-check-input s-curve-checkbox" id="${rowId}_scurve"></td>
        `;

        // Find the right place to insert
        const tbody = document.getElementById('cashflowTableBody');
        let insertBefore = null;

        if (section === 'acquisition') {
            insertBefore = tbody.querySelector('[data-item="construction_cost"]')?.closest('tr').previousElementSibling;
        } else if (section === 'development') {
            insertBefore = tbody.querySelector('[data-item="tdc_subtotal"]');
        }

        if (insertBefore) {
            tbody.insertBefore(newRow, insertBefore);
        }

        // Initialize the new row
        initializeCashflowCells();
        updateRateFromAmount(rowId);

        // Add event listeners
        attachRowListeners(newRow);
    }

    // Format number with commas
    function formatNumberWithCommas(value) {
        // Remove existing commas and parse
        const numValue = parseFloat(String(value).replace(/,/g, ''));
        if (isNaN(numValue)) return '';
        return numValue.toLocaleString('en-US', { maximumFractionDigits: 0 });
    }

    // Remove commas from formatted number
    function removeCommas(value) {
        return String(value).replace(/,/g, '');
    }

    // Attach event listeners to a row
    function attachRowListeners(row) {
        const itemId = row.getAttribute('data-item');

        // Amount input
        const amountInput = row.querySelector('.cashflow-input');
        if (amountInput) {
            // Format on blur
            amountInput.addEventListener('blur', function() {
                const rawValue = removeCommas(this.value);
                if (rawValue && !isNaN(rawValue)) {
                    this.value = formatNumberWithCommas(rawValue);
                }
            });

            // Remove commas on focus for editing
            amountInput.addEventListener('focus', function() {
                this.value = removeCommas(this.value);
            });

            amountInput.addEventListener('input', function() {
                updateRateFromAmount(itemId);
                updateRowCashflow(row);
                updateTDCDisplay();
                updateLoanFromCalculator();
                updateEquityFromPercentage();
            });
        }

        // Rate input
        const rateInput = row.querySelector('.rate-input');
        if (rateInput) {
            rateInput.addEventListener('input', function() {
                updateAmountFromRate(itemId);
                updateRowCashflow(row);
                updateTDCDisplay();
                updateLoanFromCalculator();
                updateEquityFromPercentage();
            });
        }

        // Metric select
        const metricSelect = row.querySelector('.metric-select');
        if (metricSelect) {
            metricSelect.addEventListener('change', function() {
                updateRateFromAmount(itemId);
            });
        }

        // Timing inputs
        row.querySelectorAll('input[id$="_start"], input[id$="_span"]').forEach(input => {
            input.addEventListener('input', function() {
                updateRowCashflow(row);
            });

            // On blur, check if we need to adjust month count
            input.addEventListener('blur', function() {
                const requiredMonths = calculateRequiredMonths();
                if (requiredMonths !== NUM_MONTHS) {
                    reinitializeMonthHeaders();
                }
            });
        });

        // S-curve checkbox
        const scurveCheckbox = row.querySelector('.s-curve-checkbox');
        if (scurveCheckbox) {
            scurveCheckbox.addEventListener('change', function() {
                updateRowCashflow(row);
            });
        }
    }

    // ===== LOAD GENERATOR DATA FUNCTION =====
    function loadGeneratorData() {
        const generatorData = sessionStorage.getItem('generatorToCashflow');
        if (!generatorData) return false;

        try {
            const data = JSON.parse(generatorData);

            // Only load if from generator
            if (data.source !== 'generator') return false;

            // Update project info
            if (data.address) {
                document.getElementById('project_name').value = data.address;
            }

            // Update building metrics
            if (data.site_area) {
                document.getElementById('site_area').value = data.site_area;
            }
            if (data.gfa) {
                document.getElementById('gfa').value = data.gfa;
            }
            if (data.num_units) {
                document.getElementById('num_units').value = data.num_units;
            }
            if (data.efficiency_nsa_gfa) {
                document.getElementById('efficiency_nsa_gfa').value = data.efficiency_nsa_gfa;
            }

            // Clear the sessionStorage so it doesn't reload on refresh
            sessionStorage.removeItem('generatorToCashflow');

            // Show notification
            showToast(`Loaded building data: ${data.building_type} - ${data.gfa.toLocaleString()} m¬≤ GFA`);

            return true;
        } catch (e) {
            console.error('Error loading generator data:', e);
            return false;
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we came from generator and load data
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('from') === 'generator') {
            setTimeout(() => {
                if (loadGeneratorData()) {
                    // Trigger recalculations
                    updateEfficiencies();
                    updateAllCashflow();
                    updateTDCDisplay();
                    updateEquityFromPercentage();
                    updateLoanFromCalculator();
                }
            }, 100);
        }

        // Initialize month headers and cells (auto-calculates required months)
        reinitializeMonthHeaders();

        // Initialize all rates from amounts
        document.querySelectorAll('.cashflow-row:not([data-is-calculated="true"])').forEach(row => {
            const itemId = row.getAttribute('data-item');
            updateRateFromAmount(itemId);
        });

        // Update TDC, equity, and loan calculator on load
        updateTDCDisplay();
        updateEquityFromPercentage();
        updateLoanFromCalculator();

        // After initial load, check if we need to adjust months based on actual values
        setTimeout(() => {
            const requiredMonths = calculateRequiredMonths();
            if (requiredMonths !== NUM_MONTHS) {
                reinitializeMonthHeaders();
            }
        }, 100);

        // Add live update listeners to amount inputs
        const amountInputs = document.querySelectorAll('.cashflow-input');
        amountInputs.forEach(input => {
            input.addEventListener('input', function() {
                const itemId = this.id;
                const row = this.closest('.cashflow-row');

                // Update rate from amount
                updateRateFromAmount(itemId);

                // Update cashflow display
                if (row) {
                    updateRowCashflow(row);
                }

                // Update TDC and financing calculations
                updateTDCDisplay();
                updateEquityFromPercentage();
                updateLoanFromCalculator();
            });
        });

        // Add listeners to rate inputs
        const rateInputs = document.querySelectorAll('.rate-input');
        rateInputs.forEach(input => {
            input.addEventListener('input', function() {
                const itemId = this.id.replace('_rate', '');
                const row = this.closest('.cashflow-row');

                // Update amount from rate
                updateAmountFromRate(itemId);

                // Update cashflow display
                if (row) {
                    updateRowCashflow(row);
                }

                // Update TDC and financing calculations
                updateTDCDisplay();
                updateEquityFromPercentage();
                updateLoanFromCalculator();
            });
        });

        // Add listeners to metric selects
        const metricSelects = document.querySelectorAll('.metric-select');
        metricSelects.forEach(select => {
            select.addEventListener('change', function() {
                const itemId = this.getAttribute('data-item');
                // When metric changes, recalculate rate from amount
                updateRateFromAmount(itemId);
            });
        });

        // Add listeners to start, span, and S-curve checkboxes
        const timingInputs = document.querySelectorAll('input[id$="_start"], input[id$="_span"]');
        timingInputs.forEach(input => {
            input.addEventListener('input', function() {
                const row = this.closest('.cashflow-row');
                if (row) {
                    updateRowCashflow(row);
                }
            });

            // On blur, check if we need to adjust month count
            input.addEventListener('blur', function() {
                const requiredMonths = calculateRequiredMonths();
                if (requiredMonths !== NUM_MONTHS) {
                    reinitializeMonthHeaders();
                }
            });
        });

        const scurveCheckboxes = document.querySelectorAll('.s-curve-checkbox');
        scurveCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const row = this.closest('.cashflow-row');
                if (row) {
                    updateRowCashflow(row);
                }
            });
        });

        // LVR/LTC Calculator listeners
        document.getElementById('loan_calc_method').addEventListener('change', updateLoanFromCalculator);
        document.getElementById('loan_calc_pct').addEventListener('input', updateLoanFromCalculator);

        // Equity percentage input listener
        document.getElementById('equity_pct_input').addEventListener('input', function() {
            updateEquityFromPercentage();
            updateLoanFromCalculator(); // LTC depends on TDC changes
            updateAllCashflow(); // May affect TDC if using % TDC metric
        });

        // Interest rate listeners - trigger financing recalculation
        document.getElementById('equity_interest_rate').addEventListener('input', function() {
            updateWaterfallFinancing();
        });

        document.getElementById('loan_interest_rate').addEventListener('input', function() {
            updateWaterfallFinancing();
        });

        // Construction start changes affect when loan refinances equity
        const constructionStartInput = document.getElementById('construction_cost_start');
        if (constructionStartInput) {
            constructionStartInput.addEventListener('blur', function() {
                updateWaterfallFinancing();
            });
        }

        // Calculate button handler (for full backend calculation)
        document.getElementById('calculateBtn').addEventListener('click', function() {
            updateAllCashflow();
            document.getElementById('metricsSection').style.display = 'block';
        });

        // Set default start date to today
        const startDateInput = document.getElementById('start_date');
        if (startDateInput && !startDateInput.value) {
            const today = new Date().toISOString().split('T')[0];
            startDateInput.value = today;
        }

        // Removed thousand separator formatting from amount inputs to allow proper saving

        // Function to calculate NSA and GBA from GFA and efficiency inputs
        function updateEfficiencies() {
            const gfa = parseFloat(document.getElementById('gfa').value) || 0;
            const effNsaGfa = parseFloat(document.getElementById('efficiency_nsa_gfa').value) || 85.0;
            const ratioGfaGba = parseFloat(document.getElementById('ratio_gfa_gba').value) || 92.9;

            // Calculate NSA from GFA √ó NSA/GFA Efficiency
            const nsa = gfa * (effNsaGfa / 100);
            document.getElementById('nsa').value = Math.round(nsa * 10) / 10; // Round to 1 decimal

            // Calculate GBA from GFA / (GFA/GBA Ratio)
            const gba = ratioGfaGba > 0 ? gfa * 100 / ratioGfaGba : 0;
            document.getElementById('gba').value = Math.round(gba * 10) / 10; // Round to 1 decimal

            // Calculate NSA/GBA Efficiency (derived)
            const effNsaGba = gba > 0 ? (nsa / gba * 100) : 0;
            document.getElementById('efficiency_nsa_gba').value = effNsaGba.toFixed(1);
        }

        // Add listeners to GFA and efficiency inputs to update areas and recalculate cashflows
        ['gfa', 'efficiency_nsa_gfa', 'ratio_gfa_gba', 'num_units'].forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('input', function() {
                    // Update calculated areas (NSA, GBA)
                    updateEfficiencies();

                    // Recalculate any rows using per sqm or per unit metrics
                    document.querySelectorAll('.cashflow-row').forEach(row => {
                        const itemId = row.getAttribute('data-item');
                        if (itemId) {
                            const metricSelect = document.getElementById(itemId + '_metric');
                            if (metricSelect) {
                                const metric = metricSelect.value;
                                // If metric is per area or per unit, recalculate
                                if (['per_gfa', 'per_nsa', 'per_gba', 'per_unit'].includes(metric)) {
                                    updateAmountFromRate(itemId);
                                    updateRowCashflow(row);
                                }
                            }
                        }
                    });

                    // Update TDC and financing calculations
                    updateTDCDisplay();
                    updateEquityFromPercentage();
                    updateLoanFromCalculator();
                    updateWaterfallFinancing();
                });
            }
        });

        // Initial calculations to set up financing displays
        updateTDCDisplay();
        updateEquityFromPercentage();
        updateLoanFromCalculator();
        updateWaterfallFinancing();
        updateEfficiencies();

        // ===== MULTI-SCENARIO SAVE/LOAD =====

        // Helper function to collect all data
        function collectScenarioData() {
            const saveData = {};

            // Save project setup inputs
            ['currency', 'project_name', 'start_date', 'site_area', 'num_units',
             'gfa', 'efficiency_nsa_gfa', 'ratio_gfa_gba'].forEach(id => {
                const input = document.getElementById(id);
                if (input) saveData[id] = input.value;
            });

            // Save all cashflow row inputs (amount, metric, rate, start, span, scurve)
            document.querySelectorAll('.cashflow-row, [data-is-static="true"]').forEach(row => {
                const itemId = row.getAttribute('data-item');
                if (itemId && !row.getAttribute('data-is-calculated')) {
                    // Amount
                    const amountInput = document.getElementById(itemId);
                    if (amountInput) saveData[itemId] = amountInput.value;

                    // Metric
                    const metricSelect = document.getElementById(itemId + '_metric');
                    if (metricSelect) saveData[itemId + '_metric'] = metricSelect.value;

                    // Rate
                    const rateInput = document.getElementById(itemId + '_rate');
                    if (rateInput) saveData[itemId + '_rate'] = rateInput.value;

                    // Start (may not exist for static rows)
                    const startInput = document.getElementById(itemId + '_start');
                    if (startInput) saveData[itemId + '_start'] = startInput.value;

                    // Span (may not exist for static rows)
                    const spanInput = document.getElementById(itemId + '_span');
                    if (spanInput) saveData[itemId + '_span'] = spanInput.value;

                    // S-curve checkbox (may not exist for static rows)
                    const scurveCheckbox = document.getElementById(itemId + '_scurve');
                    if (scurveCheckbox) saveData[itemId + '_scurve'] = scurveCheckbox.checked;
                }
            });

            // Save financing inputs
            ['equity_pct_input', 'equity_interest_rate', 'loan_calc_method',
             'loan_calc_pct', 'loan_max_limit', 'loan_interest_rate',
             'loan_establishment_fee_pct', 'loan_line_fee_pct'].forEach(id => {
                const input = document.getElementById(id);
                if (input) saveData[id] = input.value;
            });

            return saveData;
        }

        // Helper function to load scenario data
        function loadScenarioData(data) {
            // Load all saved values
            Object.keys(data).forEach(key => {
                const elem = document.getElementById(key);
                if (elem) {
                    if (elem.type === 'checkbox') {
                        elem.checked = data[key];
                    } else {
                        elem.value = data[key];
                    }
                }
            });

            // Recalculate everything
            updateEfficiencies();
            updateAllCashflow();
            updateTDCDisplay();
            updateEquityFromPercentage();
            updateLoanFromCalculator();
        }

        // Load scenarios list
        function loadScenariosList() {
            const select = document.getElementById('scenarioSelect');
            select.innerHTML = '<option value="">Select scenario...</option>';

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('scenario_')) {
                    const name = key.replace('scenario_', '');
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = name;
                    select.appendChild(option);
                }
            }
        }

        // Save scenario
        document.getElementById('saveScenarioBtn').addEventListener('click', function() {
            const scenarioName = document.getElementById('scenarioName').value.trim();
            if (!scenarioName) {
                alert('Please enter a scenario name');
                return;
            }

            const saveData = collectScenarioData();

            // Save with unique key
            localStorage.setItem('scenario_' + scenarioName, JSON.stringify(saveData));

            // Update list and show confirmation
            loadScenariosList();
            const statusElem = document.getElementById('scenarioStatus');
            statusElem.textContent = '‚úì Saved: ' + scenarioName;
            statusElem.className = 'text-success';
            setTimeout(() => statusElem.textContent = '', 3000);
        });

        // Load scenario
        document.getElementById('loadScenarioBtn').addEventListener('click', function() {
            const key = document.getElementById('scenarioSelect').value;
            if (!key) {
                alert('Please select a scenario to load');
                return;
            }

            const savedData = localStorage.getItem(key);
            if (!savedData) {
                alert('Scenario not found');
                return;
            }

            const data = JSON.parse(savedData);
            loadScenarioData(data);

            const statusElem = document.getElementById('scenarioStatus');
            statusElem.textContent = '‚úì Loaded';
            statusElem.className = 'text-info';
            setTimeout(() => statusElem.textContent = '', 3000);
        });

        // Delete scenario
        document.getElementById('deleteScenarioBtn').addEventListener('click', function() {
            const key = document.getElementById('scenarioSelect').value;
            if (!key) {
                alert('Please select a scenario to delete');
                return;
            }

            if (confirm('Delete this scenario?')) {
                localStorage.removeItem(key);
                loadScenariosList();
                const statusElem = document.getElementById('scenarioStatus');
                statusElem.textContent = '‚úì Deleted';
                statusElem.className = 'text-warning';
                setTimeout(() => statusElem.textContent = '', 3000);
            }
        });

        // Initialize scenarios list on load
        loadScenariosList();
    });

    // Currency symbol mapping
    const currencySymbols = {
        'AUD': '$',
        'USD': '$',
        'GBP': '¬£',
        'EUR': '‚Ç¨',
        'NZD': '$',
        'SGD': 'S$'
    };

    // Global currency state
    let currentCurrency = 'AUD';

    // Helper function to get currency symbol
    function getCurrencySymbol() {
        return currencySymbols[currentCurrency] || '$';
    }

    // Helper function to format currency with proper symbol
    function formatCurrencyValue(value, showSymbol = true) {
        const absValue = Math.abs(value);
        const formatted = absValue.toLocaleString('en-AU', {maximumFractionDigits: 0});
        const symbol = showSymbol ? getCurrencySymbol() : '';
        return symbol + formatted;
    }

    // Function to update all currency labels
    function updateCurrencyLabels() {
        const symbol = getCurrencySymbol();
        document.querySelectorAll('.currency-label').forEach(label => {
            const baseText = label.textContent.replace(/\s*\(.*?\)\s*$/, '').trim();
            label.textContent = `${baseText} (${symbol})`;
        });
    }

    // ===== AUTO-SAVE AND RESTORE FUNCTIONALITY =====

    const AUTOSAVE_KEY = 'cashflow_form_autosave';
    const AUTOSAVE_TIMESTAMP_KEY = 'cashflow_form_autosave_timestamp';

    // Function to save form data to localStorage
    function saveFormData() {
        const formData = {};

        // Get all form inputs
        const form = document.getElementById('acquisitionForm');
        const inputs = form.querySelectorAll('input, select');

        inputs.forEach(input => {
            if (input.id) {
                // Store value as-is (with commas for currency fields)
                formData[input.id] = input.value || '';
            }
        });

        // Save unit mix table data
        const unitMixRows = [];
        document.querySelectorAll('#unitMixTableBody tr').forEach(row => {
            const typeInput = row.querySelector('input[type="text"]');
            const countInput = row.querySelector('.unit-count');
            const areaInput = row.querySelector('.unit-area');

            if (typeInput && countInput && areaInput) {
                unitMixRows.push({
                    type: typeInput.value,
                    count: countInput.value,
                    area: areaInput.value
                });
            }
        });
        formData['unitMixRows'] = unitMixRows;

        // Save to localStorage
        const now = new Date();
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(formData));
        localStorage.setItem(AUTOSAVE_TIMESTAMP_KEY, now.toISOString());

        // Update status indicator
        const statusEl = document.getElementById('autoSaveStatus');
        if (statusEl) {
            statusEl.textContent = '‚úì Saved';
            statusEl.style.color = '#28a745';

            setTimeout(() => {
                const savedTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                statusEl.textContent = `Last saved: ${savedTime}`;
                statusEl.style.color = '#6c757d';
            }, 2000);
        }
    }

    // Function to restore form data from localStorage
    function restoreFormData() {
        const savedData = localStorage.getItem(AUTOSAVE_KEY);

        if (!savedData) {
            return false;
        }

        try {
            const formData = JSON.parse(savedData);
            const timestamp = localStorage.getItem(AUTOSAVE_TIMESTAMP_KEY);

            // Restore all input values
            Object.keys(formData).forEach(fieldId => {
                if (fieldId === 'unitMixRows') return; // Handle separately

                const field = document.getElementById(fieldId);
                if (field && formData[fieldId] !== undefined) {
                    field.value = formData[fieldId];
                }
            });

            // Restore unit mix table
            if (formData.unitMixRows && formData.unitMixRows.length > 0) {
                const tbody = document.getElementById('unitMixTableBody');
                tbody.innerHTML = '';

                formData.unitMixRows.forEach((rowData) => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="form-control form-control-sm" value="${rowData.type}" style="font-size: 0.75rem; padding: 0.2rem 0.3rem;"></td>
                        <td><input type="number" class="form-control form-control-sm unit-count" value="${rowData.count}" min="0" style="font-size: 0.75rem; padding: 0.2rem 0.3rem;"></td>
                        <td><input type="number" class="form-control form-control-sm unit-area" value="${rowData.area}" step="0.1" style="font-size: 0.75rem; padding: 0.2rem 0.3rem;"></td>
                        <td><input type="text" class="form-control form-control-sm unit-total" readonly style="font-size: 0.75rem; padding: 0.2rem 0.3rem; background-color: #e9ecef;"></td>
                        <td><button type="button" class="btn btn-sm btn-danger remove-unit-row" style="font-size: 0.6rem; padding: 0.1rem 0.3rem;">√ó</button></td>
                    `;
                    tbody.appendChild(newRow);
                });

                attachUnitMixListeners();
                updateUnitMix();
            }

            // Trigger calculations
            updateCalculatedFields();

            // Update status indicator
            const statusEl = document.getElementById('autoSaveStatus');
            if (statusEl && timestamp) {
                const savedDate = new Date(timestamp);
                const savedTime = savedDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                statusEl.textContent = `Last saved: ${savedTime}`;
                statusEl.style.color = '#6c757d';
            }

            return true;
        } catch (e) {
            console.error('Error restoring form data:', e);
            return false;
        }
    }

    // Removed complex auto-save scheduling - now saves immediately on blur/enter

    // Function to clear saved data and reset form
    function clearSavedData() {
        if (confirm('Are you sure you want to clear all saved data and reset the form? This cannot be undone.')) {
            // Clear localStorage
            localStorage.removeItem(AUTOSAVE_KEY);
            localStorage.removeItem(AUTOSAVE_TIMESTAMP_KEY);

            // Reload page to reset form
            window.location.reload();
        }
    }

    // Set today's date as default
    document.getElementById('start_date').valueAsDate = new Date();

    // Check for building data from Building Generator & Site data from GIS
    function loadBuildingData() {
        const buildingDataStr = sessionStorage.getItem('selectedBuilding');
        const siteDataStr = sessionStorage.getItem('selectedLot');

        let buildingData = null;
        let siteData = null;

        // Load building data if available
        if (buildingDataStr) {
            try {
                buildingData = JSON.parse(buildingDataStr);
            } catch (e) {
                console.error('Error parsing building data:', e);
            }
        }

        // Load site data if available
        if (siteDataStr) {
            try {
                siteData = JSON.parse(siteDataStr);
            } catch (e) {
                console.error('Error parsing site data:', e);
            }
        }

        // Prefill form with building/site data
        if (buildingData || siteData) {
            // Project details
            if (siteData && siteData.address) {
                document.getElementById('project_name').value = `Development - ${siteData.address}`;
            } else if (buildingData && buildingData.name) {
                document.getElementById('project_name').value = buildingData.name;
            }

            // Site metrics and Unit Mix from Building Generator
            if (buildingData) {
                if (buildingData.gfa) document.getElementById('gfa').value = buildingData.gfa;
                if (buildingData.gba) document.getElementById('gba').value = buildingData.gba;
                if (buildingData.siteArea) document.getElementById('site_area').value = buildingData.siteArea;
                if (buildingData.gfa) document.getElementById('nsa').value = Math.round(buildingData.gfa * 0.85);

                // Populate Unit Mix table from building generator data
                if (buildingData.unitMix && Array.isArray(buildingData.unitMix)) {
                    const tbody = document.getElementById('unitMixTableBody');
                    tbody.innerHTML = ''; // Clear existing rows

                    buildingData.unitMix.forEach((unit) => {
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td><input type="text" class="form-control form-control-sm" value="${unit.type || unit.name || ''}" style="font-size: 0.75rem; padding: 0.2rem 0.3rem;"></td>
                            <td><input type="number" class="form-control form-control-sm unit-count" value="${unit.count || 0}" min="0" style="font-size: 0.75rem; padding: 0.2rem 0.3rem;"></td>
                            <td><input type="number" class="form-control form-control-sm unit-area" value="${unit.area || 0}" step="0.1" style="font-size: 0.75rem; padding: 0.2rem 0.3rem;"></td>
                            <td><input type="text" class="form-control form-control-sm unit-total" readonly style="font-size: 0.75rem; padding: 0.2rem 0.3rem; background-color: #e9ecef;"></td>
                            <td><button type="button" class="btn btn-sm btn-danger remove-unit-row" style="font-size: 0.6rem; padding: 0.1rem 0.3rem;">√ó</button></td>
                        `;
                        tbody.appendChild(newRow);
                    });

                    // Re-attach listeners and update totals
                    attachUnitMixListeners();
                    updateUnitMix();
                }
            } else if (siteData && siteData.area) {
                document.getElementById('site_area').value = parseFloat(siteData.area) || 0;
                // Estimate GFA based on FSR if available
                if (siteData.fsr_control) {
                    const estimatedGFA = parseFloat(siteData.area) * parseFloat(siteData.fsr_control);
                    document.getElementById('gfa').value = Math.round(estimatedGFA);
                    document.getElementById('gba').value = Math.round(estimatedGFA * 1.1);
                    document.getElementById('nsa').value = Math.round(estimatedGFA * 0.85);
                }
            }

            // Estimated costs based on GFA (Industry benchmark rates - Australia 2025)
            const gfa = parseFloat(document.getElementById('gfa').value) || 0;
            if (gfa > 0) {
                // === ACQUISITION COSTS ===
                // Land value benchmark: $600-1,200/sqm depending on location (Sydney metro)
                // Using conservative $650/sqm for outer suburbs, $1,000+ for inner city
                const siteArea = (siteData && siteData.area) ? parseFloat(siteData.area) : 600;
                const landRatePerSqm = 650; // Conservative rate for planning purposes
                const estimatedLandValue = siteArea * landRatePerSqm;

                document.getElementById('purchase_price').value = Math.round(estimatedLandValue);

                // Stamp Duty: NSW residential ~4.5-5.5% depending on value threshold
                // Includes foreign purchaser surcharge if applicable
                document.getElementById('stamp_duty').value = Math.round(estimatedLandValue * 0.048);

                // Legal Fees: Typically 0.8-1.2% of purchase price for commercial transactions
                document.getElementById('legal_fees').value = Math.round(estimatedLandValue * 0.01);

                // Survey Fees: $3,000-5,000 for standard residential sites
                document.getElementById('survey_fees').value = 3500;

                // Agent Fees: 1.5-2% of purchase price (if using buyer's agent)
                document.getElementById('agent_fees').value = Math.round(estimatedLandValue * 0.0175);

                // === DEVELOPMENT COSTS ===
                // Construction Rates (2025 benchmarks):
                // - Low-rise residential (1-4 floors): $2,500-3,200/sqm GFA
                // - Mid-rise residential (5-9 floors): $3,000-3,800/sqm GFA
                // - High-rise residential (10+ floors): $3,500-4,500/sqm GFA
                // Using mid-range $3,200/sqm for multi-unit developments
                const constructionRate = 3200;
                const totalConstruction = gfa * constructionRate;
                document.getElementById('construction_cost').value = Math.round(totalConstruction);

                // Demolition: $15,000-30,000 for standard house, more for large buildings
                document.getElementById('demolition').value = 18000;

                // Professional Fees: Typically 8-12% of total construction cost
                // Includes architect, structural engineer, services engineer, town planner, certifier
                document.getElementById('professional_fees').value = Math.round(totalConstruction * 0.10);

                // Planning Fees: DA application + consultants $6,000-12,000
                document.getElementById('planning_fees').value = 8500;

                // Building Control/Certifier: $4,000-8,000 depending on project size
                document.getElementById('building_control').value = Math.round(gfa * 6);

                // S106/CIL (Section 7.11 Contributions in NSW): $40-80/sqm GFA
                // Varies significantly by council - using mid-range
                document.getElementById('s106_cil').value = Math.round(gfa * 60);

                // Utilities: Connection fees $10,000-20,000 (electricity, water, sewer, gas)
                document.getElementById('utilities').value = 14000;

                // Marketing: $800-1,500 per unit typical + display suite costs
                // Estimate 10-12 units for 800sqm GFA = ~$12,000
                const estimatedUnits = Math.round(gfa / 70); // Assume avg 70sqm per unit
                document.getElementById('marketing').value = Math.max(8000, estimatedUnits * 1000);

                // Contingency: Industry standard 5-8% of total construction cost
                // Using 6% as balanced approach
                document.getElementById('contingency').value = Math.round(totalConstruction * 0.06);

                // === REVENUE (GDV) ===
                // Residential Sale Rates (2025 Sydney market benchmarks):
                // - Outer suburbs: $5,500-7,000/sqm
                // - Middle ring: $7,000-9,000/sqm
                // - Inner city: $9,000-13,000/sqm
                // Using conservative $7,200/sqm for feasibility
                const gdvRate = 7200;
                document.getElementById('gdv_rate_per_sqm').value = gdvRate;

                // Sales Legal: $2,500-4,000 for standard conveyancing
                document.getElementById('sales_legal').value = 3000;

                // === FINANCING ===
                // Set reasonable defaults for financing structure
                const totalProjectCost = estimatedLandValue + totalConstruction + (totalConstruction * 0.25); // Land + Construction + soft costs

                // Equity: Typically 20-30% of total project costs
                document.getElementById('equity_max_limit').value = Math.round(totalProjectCost * 0.25);

                // Senior Loan: Typically 60-70% LTC (Loan-to-Cost)
                document.getElementById('loan_max_limit').value = Math.round(totalProjectCost * 0.65);

                // Mezzanine: 10-15% as overdraft facility
                document.getElementById('mezz_max_limit').value = Math.round(totalProjectCost * 0.10);
            }

            // Format all currency fields
            currencyFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    field.value = formatNumber(field.value);
                }
            });

            // Trigger calculations
            updateCalculatedFields();

            // Clear sessionStorage
            if (buildingDataStr) sessionStorage.removeItem('selectedBuilding');
            if (siteDataStr) sessionStorage.removeItem('selectedLot');

            console.log('Building/Site data loaded - form prefilled with estimates');
        }
    }

    // Load building data on page load
    loadBuildingData();

    // Update currency labels on page load
    updateCurrencyLabels();

    // Listen for currency changes
    document.getElementById('currency').addEventListener('change', function() {
        currentCurrency = this.value;
        updateCurrencyLabels();
    });

    // ===== ULTRA-SIMPLE INPUT HANDLING - NO INTERFERENCE =====

    // List of currency fields
    const currencyFields = [
        'purchase_price', 'stamp_duty', 'legal_fees', 'survey_fees', 'agent_fees', 'other_acquisition',
        'construction_cost', 'demolition', 'professional_fees', 'planning_fees', 'building_control',
        's106_cil', 'utilities', 'marketing', 'contingency', 'other_development',
        'sales_legal', 'equity_opening', 'equity_max_limit', 'loan_opening', 'loan_max_limit',
        'mezz_opening', 'mezz_max_limit', 'gdv_rate_per_sqm', 'gdv'
    ];

    // Simple formatter
    function formatNumber(value) {
        if (!value) return '';
        const str = String(value).replace(/,/g, '');
        const num = parseFloat(str);
        if (isNaN(num)) return '';
        return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
    }

    // Clean number
    function cleanNumber(value) {
        if (!value) return '';
        return String(value).replace(/,/g, '');
    }

    // NO EVENT LISTENERS ON INPUTS - LET THEM WORK NATURALLY
    // Only format on page load
    currencyFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field) return;

        // Format existing value ONCE on page load
        if (field.value && field.value.trim()) {
            const formatted = formatNumber(field.value);
            if (formatted) field.value = formatted;
        }
    });

    // ===== UNIT MIX FUNCTIONALITY =====

    // Function to update unit mix totals and number of units
    function updateUnitMix() {
        const rows = document.querySelectorAll('#unitMixTableBody tr');
        let totalUnits = 0;

        rows.forEach(row => {
            const countInput = row.querySelector('.unit-count');
            const areaInput = row.querySelector('.unit-area');
            const totalInput = row.querySelector('.unit-total');

            if (countInput && areaInput && totalInput) {
                const count = parseFloat(countInput.value) || 0;
                const area = parseFloat(areaInput.value) || 0;
                const total = count * area;

                totalInput.value = total.toFixed(1);
                totalUnits += count;
            }
        });

        // Update total units field
        document.getElementById('num_units').value = totalUnits;
    }

    // Add event listeners to unit mix inputs
    function attachUnitMixListeners() {
        const tbody = document.getElementById('unitMixTableBody');

        tbody.querySelectorAll('.unit-count, .unit-area').forEach(input => {
            input.addEventListener('input', updateUnitMix);
        });

        tbody.querySelectorAll('.remove-unit-row').forEach(button => {
            button.addEventListener('click', function() {
                if (tbody.querySelectorAll('tr').length > 1) {
                    this.closest('tr').remove();
                    updateUnitMix();
                }
            });
        });
    }

    // Add new unit row
    document.getElementById('addUnitRow').addEventListener('click', function() {
        const tbody = document.getElementById('unitMixTableBody');
        const rowCount = tbody.querySelectorAll('tr').length;

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control form-control-sm" value="${rowCount + 1} Bed" style="font-size: 0.75rem; padding: 0.2rem 0.3rem;"></td>
            <td><input type="number" class="form-control form-control-sm unit-count" value="0" min="0" style="font-size: 0.75rem; padding: 0.2rem 0.3rem;"></td>
            <td><input type="number" class="form-control form-control-sm unit-area" value="50" step="0.1" style="font-size: 0.75rem; padding: 0.2rem 0.3rem;"></td>
            <td><input type="text" class="form-control form-control-sm unit-total" readonly style="font-size: 0.75rem; padding: 0.2rem 0.3rem; background-color: #e9ecef;"></td>
            <td><button type="button" class="btn btn-sm btn-danger remove-unit-row" style="font-size: 0.6rem; padding: 0.1rem 0.3rem;">√ó</button></td>
        `;

        tbody.appendChild(newRow);
        attachUnitMixListeners();
        updateUnitMix();
    });

    // Initialize unit mix
    attachUnitMixListeners();
    updateUnitMix();

    // NO AUTO-SAVE LISTENERS - Let inputs work naturally
    // User will click "Calculate Cashflow" button to calculate

    // ===== RESTORE SAVED DATA ON PAGE LOAD =====

    // Try to restore saved data, but don't override if building data is present
    const hasBuildingData = sessionStorage.getItem('selectedBuilding') || sessionStorage.getItem('selectedLot');
    if (!hasBuildingData) {
        restoreFormData();
    }

    // Auto-load cashflow on page load
    setTimeout(() => {
        // Click the calculate button programmatically to load cashflow
        const calculateBtn = document.querySelector('#acquisitionForm button[type="submit"]');
        if (calculateBtn) {
            calculateBtn.click();
        }
    }, 500); // Wait 0.5 second for all data to load

    // ===== CALCULATED FIELDS =====

    // Function to get numeric value from input (handles commas)
    function getRawValue(fieldId) {
        const field = document.getElementById(fieldId);
        if (!field || !field.value) return 0;
        const cleanValue = cleanNumber(field.value);
        return parseFloat(cleanValue) || 0;
    }

    // Update all calculated fields
    function updateCalculatedFields() {
        // 1. FSR Calculation (GFA / Site Area)
        const siteArea = getRawValue('site_area');
        const gfa = getRawValue('gfa');
        const fsrField = document.getElementById('fsr_calc');
        if (siteArea > 0) {
            const fsr = gfa / siteArea;
            fsrField.value = fsr.toFixed(2);
        } else {
            fsrField.value = '';
        }

        // 2. Construction Cost per sqm GFA
        const constructionCost = getRawValue('construction_cost');
        const constructionPerSqmField = document.getElementById('construction_cost_per_sqm');
        if (gfa > 0) {
            const costPerSqm = constructionCost / gfa;
            constructionPerSqmField.value = formatNumber(costPerSqm.toFixed(0));
        } else {
            constructionPerSqmField.value = '';
        }

        // 3. Professional Fees % of TDC
        const professionalFees = getRawValue('professional_fees');
        const demolition = getRawValue('demolition');
        const planningFees = getRawValue('planning_fees');
        const buildingControl = getRawValue('building_control');
        const s106Cil = getRawValue('s106_cil');
        const utilities = getRawValue('utilities');
        const marketing = getRawValue('marketing');
        const contingency = getRawValue('contingency');
        const otherDevelopment = getRawValue('other_development');

        const tdc = constructionCost + demolition + professionalFees + planningFees +
                    buildingControl + s106Cil + utilities + marketing + contingency + otherDevelopment;

        const professionalFeesPctField = document.getElementById('professional_fees_pct_tdc');
        if (tdc > 0) {
            const pct = (professionalFees / tdc) * 100;
            professionalFeesPctField.value = pct.toFixed(2) + '%';
        } else {
            professionalFeesPctField.value = '';
        }

        // 4. Total GDV (rate per sqm * GFA) - only auto-calculate if rate is provided
        const gdvRate = getRawValue('gdv_rate_per_sqm');
        const gdvField = document.getElementById('gdv');

        // Only update GDV if user has entered a rate per sqm AND gfa exists
        // This prevents overwriting manually-entered GDV values
        if (gdvRate > 0 && gfa > 0) {
            const totalGdv = gdvRate * gfa;
            gdvField.value = formatNumber(totalGdv.toFixed(0));
        }
        // If gdvRate is 0 or empty, preserve whatever value is in the GDV field
    }

    // Calculations run on initial page load
    updateCalculatedFields(); // Run once on page load

    // Helper function to display cashflow in the right panel
    function displayLiveCashflow(monthlyData) {
        const container = document.getElementById('cashflowTableContainer');
        if (!container || !monthlyData) return;

        // Build a simple HTML table
        let html = '<table class="table table-sm table-striped table-hover" style="font-size: 0.75rem; margin: 0;">';
        html += '<thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">';
        html += '<tr>';
        html += '<th>Month</th><th>Date</th><th>Costs</th><th>Revenue</th><th>Net CF</th><th>Cumulative</th>';
        html += '</tr></thead><tbody>';

        monthlyData.forEach(month => {
            const costs = month.Acquisition + month.Development;
            const netCf = month.Net_Cashflow;
            const cumulative = month.Cumulative_Cashflow;

            html += '<tr>';
            html += `<td>${month.Month}</td>`;
            html += `<td>${new Date(month.Date).toLocaleDateString('en-AU', {month: 'short', year: '2-digit'})}</td>`;
            html += `<td style="color: ${costs < 0 ? '#dc3545' : 'black'}">${formatCurrencyValue(costs)}</td>`;
            html += `<td style="color: ${month.Revenue > 0 ? '#28a745' : 'black'}">${formatCurrencyValue(month.Revenue)}</td>`;
            html += `<td style="color: ${netCf < 0 ? '#dc3545' : '#28a745'}; font-weight: 500;">${formatCurrencyValue(netCf)}</td>`;
            html += `<td style="color: ${cumulative < 0 ? '#dc3545' : '#28a745'}; font-weight: bold;">${formatCurrencyValue(cumulative)}</td>`;
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // LVR/LTC Calculator Logic
    function calculateLoanMaxLimit() {
        const method = document.getElementById('loan_calc_method').value;
        const percentage = parseFloat(document.getElementById('loan_calc_percentage').value) || 0;
        const loanMaxLimitInput = document.getElementById('loan_max_limit');
        const hintElement = document.getElementById('loan_calc_hint');
        const percentageInput = document.getElementById('loan_calc_percentage');

        if (method === 'manual') {
            // Manual mode - loan_max_limit is editable
            loanMaxLimitInput.disabled = false;
            percentageInput.disabled = true;
            hintElement.textContent = 'Enter Max Limit manually below';
            hintElement.style.color = '';
        } else {
            // LVR or LTC mode - loan_max_limit is calculated
            loanMaxLimitInput.disabled = true;
            percentageInput.disabled = false;

            if (method === 'lvr') {
                // LVR: Loan-to-Value (% of GDV)
                const gdv = getRawValue('gdv');
                const calculatedLimit = (gdv * percentage) / 100;
                loanMaxLimitInput.value = formatNumber(Math.round(calculatedLimit));
                hintElement.textContent = `${percentage}% of GDV (${formatCurrencyValue(gdv)}) = ${formatCurrencyValue(calculatedLimit)}`;
                hintElement.style.color = '#0066cc';
            } else if (method === 'ltc') {
                // LTC: Loan-to-Cost (% of Total Costs)
                // Calculate total costs using raw values
                const purchase_price = getRawValue('purchase_price');
                const stamp_duty = getRawValue('stamp_duty');
                const legal_fees = getRawValue('legal_fees');
                const survey_fees = getRawValue('survey_fees');
                const agent_fees = getRawValue('agent_fees');
                const other_acquisition = getRawValue('other_acquisition');
                const construction_cost = getRawValue('construction_cost');
                const demolition = getRawValue('demolition');
                const professional_fees = getRawValue('professional_fees');
                const planning_fees = getRawValue('planning_fees');
                const building_control = getRawValue('building_control');
                const s106_cil = getRawValue('s106_cil');
                const utilities = getRawValue('utilities');
                const marketing = getRawValue('marketing');
                const contingency = getRawValue('contingency');
                const other_development = getRawValue('other_development');

                const totalCosts = purchase_price + stamp_duty + legal_fees + survey_fees + agent_fees + other_acquisition +
                                 construction_cost + demolition + professional_fees + planning_fees + building_control +
                                 s106_cil + utilities + marketing + contingency + other_development;

                const calculatedLimit = (totalCosts * percentage) / 100;
                loanMaxLimitInput.value = formatNumber(Math.round(calculatedLimit));
                hintElement.textContent = `${percentage}% of Total Costs (${formatCurrencyValue(totalCosts)}) = ${formatCurrencyValue(calculatedLimit)}`;
                hintElement.style.color = '#0066cc';
            }
        }
    }

    // Removed automatic LVR/LTC recalculation on input blur - prevents interference with user input
    // Calculations now only happen when clicking "Calculate Cashflow" button

    // Form submission
    document.getElementById('acquisitionForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Show loading, hide results
        document.getElementById('loading').style.display = 'block';
        document.getElementById('welcomeMessage').style.display = 'none';
        document.getElementById('metricsSection').style.display = 'none';
        document.getElementById('cashflowTableSection').style.display = 'none';
        document.getElementById('chartsSection').style.display = 'none';

        // Update global currency
        currentCurrency = document.getElementById('currency').value;

        // Gather form data (use raw values for currency fields)
        const formData = {
            // Project details
            currency: currentCurrency,
            project_name: document.getElementById('project_name').value,
            start_date: document.getElementById('start_date').value,
            discount_rate: document.getElementById('discount_rate').value,

            // Land acquisition
            purchase_price: getRawValue('purchase_price'),
            stamp_duty: getRawValue('stamp_duty'),
            legal_fees: getRawValue('legal_fees'),
            survey_fees: getRawValue('survey_fees'),
            agent_fees: getRawValue('agent_fees'),
            other_acquisition: getRawValue('other_acquisition'),

            // Development costs
            construction_cost: getRawValue('construction_cost'),
            demolition: getRawValue('demolition'),
            professional_fees: getRawValue('professional_fees'),
            planning_fees: getRawValue('planning_fees'),
            building_control: getRawValue('building_control'),
            s106_cil: getRawValue('s106_cil'),
            utilities: getRawValue('utilities'),
            marketing: getRawValue('marketing'),
            contingency: getRawValue('contingency'),
            other_development: getRawValue('other_development'),

            // Program
            acquisition_month: document.getElementById('acquisition_month').value,
            planning_start: document.getElementById('planning_start').value,
            planning_duration: document.getElementById('planning_duration').value,
            construction_start_month: document.getElementById('construction_start_month').value,
            construction_duration: document.getElementById('construction_duration').value,
            marketing_start: document.getElementById('marketing_start').value,
            sale_month: document.getElementById('sale_month').value,

            // Revenue (use calculated GDV value)
            gdv: getRawValue('gdv'),
            sales_agent_pct: document.getElementById('sales_agent_pct').value,
            sales_legal: getRawValue('sales_legal'),

            // Financing - Equity
            equity_opening: getRawValue('equity_opening'),
            equity_max_limit: getRawValue('equity_max_limit'),
            equity_interest_rate: document.getElementById('equity_interest_rate').value,

            // Financing - Senior Loan
            loan_opening: getRawValue('loan_opening'),
            loan_max_limit: getRawValue('loan_max_limit'),
            loan_establishment_fee_pct: document.getElementById('loan_establishment_fee_pct').value,
            loan_line_fee_pct: document.getElementById('loan_line_fee_pct').value,
            loan_interest_rate: document.getElementById('loan_interest_rate').value,

            // Financing - Mezzanine Loan
            mezz_opening: getRawValue('mezz_opening'),
            mezz_max_limit: getRawValue('mezz_max_limit'),
            mezz_establishment_fee_pct: document.getElementById('mezz_establishment_fee_pct').value,
            mezz_line_fee_pct: document.getElementById('mezz_line_fee_pct').value,
            mezz_interest_rate: document.getElementById('mezz_interest_rate').value
        };

        try {
            // Send to backend
            const response = await fetch('/cashflow/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                // Display metrics
                displayMetrics(data.metrics);

                // Display cashflow in the live panel on the right
                displayLiveCashflow(data.monthly_cashflows);

                // Display cashflow table (detailed view below)
                displayCashflowTable(data.monthly_cashflows);

                // Display charts
                displayCharts(data.charts);

                // Show results
                document.getElementById('metricsSection').style.display = 'block';
                document.getElementById('cashflowTableSection').style.display = 'block';
                document.getElementById('chartsSection').style.display = 'block';
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error calculating cashflow: ' + error.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    });

    function displayMetrics(metrics) {
        // Store metrics globally for cashflow table
        window.currentMetrics = metrics;

        const formatCurrency = (value) => {
            return formatCurrencyValue(value);
        };
        const formatPercent = (value) => {
            if (isNaN(value) || !isFinite(value)) return '0.00%';
            return value.toFixed(2) + '%';
        };

        document.getElementById('metric_irr').textContent = formatPercent(metrics.project_irr || 0);
        document.getElementById('metric_profit').textContent = formatCurrency(metrics.profit || 0);
        document.getElementById('metric_margin').textContent = formatPercent(metrics.margin_on_gdv || 0);
    }

    function displayCashflowTable(monthlyData) {
        const tbody = document.getElementById('cashflowTableBody');
        const keyDatesRow = document.getElementById('keyDatesRow');
        const monthRow = document.getElementById('monthRow');
        const dateRow = document.getElementById('dateRow');

        // Update currency label in header
        document.getElementById('currencyLabel').textContent = `All amounts in ${getCurrencySymbol()}`;

        // Clear existing content
        tbody.innerHTML = '';
        keyDatesRow.innerHTML = '<th class="text-start align-middle" style="position: sticky; left: 0; background: white; z-index: 11; min-width: 150px;">Key Dates</th>';
        monthRow.innerHTML = '<th class="text-start align-middle" style="position: sticky; left: 0; background: white; z-index: 11; min-width: 150px;">Month</th>';
        dateRow.innerHTML = '<th class="text-start align-middle" style="position: sticky; left: 0; background: white; z-index: 11; min-width: 150px;">Date</th>';

        const formatCurrency = (value) => {
            const formatted = Math.abs(value).toLocaleString('en-GB', {maximumFractionDigits: 0});
            if (value < 0) return `(${formatted})`;
            return formatted;
        };

        const formatDate = (dateStr) => {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
        };

        // Get key dates from form inputs
        const acquisitionMonth = parseInt(document.getElementById('acquisition_month').value);
        const planningStart = parseInt(document.getElementById('planning_start').value);
        const planningDuration = parseInt(document.getElementById('planning_duration').value);
        const constructionStart = parseInt(document.getElementById('construction_start_month').value);
        const constructionDuration = parseInt(document.getElementById('construction_duration').value);
        const marketingStart = parseInt(document.getElementById('marketing_start').value);
        const saleMonth = parseInt(document.getElementById('sale_month').value);

        // Build header rows
        monthlyData.forEach((row, index) => {
            const monthNum = row.Month;

            // Key dates row - show key milestones with start and span
            let keyDateLabel = '';
            if (monthNum === acquisitionMonth) {
                keyDateLabel = 'Acq';
            } else if (monthNum === planningStart) {
                keyDateLabel = `Plan (${planningDuration}m)`;
            } else if (monthNum === constructionStart) {
                keyDateLabel = `Const (${constructionDuration}m)`;
            } else if (monthNum === marketingStart) {
                keyDateLabel = 'Mkt';
            } else if (monthNum === saleMonth) {
                keyDateLabel = 'Sale';
            }

            keyDatesRow.innerHTML += `<th class="text-center small" style="min-width: 90px; font-size: 0.75rem;">${keyDateLabel}</th>`;
            monthRow.innerHTML += `<th class="text-center" style="min-width: 90px;">${monthNum}</th>`;
            dateRow.innerHTML += `<th class="text-center small" style="min-width: 90px; font-size: 0.8rem;">${formatDate(row.Date)}</th>`;
        });

        // Get metrics from the global metrics object (stored when displayMetrics is called)
        const metrics = window.currentMetrics || {};

        // Build data rows - reorganized with separate sections
        const rowCategories = [
            // Project Costs Section
            { label: 'PROJECT COSTS', isSectionHeader: true },
            { label: 'Acquisition', key: 'Acquisition', isNegative: true, unit: '¬£' },
            { label: 'Development', key: 'Development', isNegative: true, unit: '¬£' },
            { label: 'Revenue', key: 'Revenue', isNegative: false, unit: '¬£' },
            { label: 'Net Project CF', key: 'Net Cashflow', isNegative: null, bold: true, unit: '¬£' },

            // Financing Section - EXPANDED WITH MEZZANINE
            { label: 'FINANCING', isSectionHeader: true },
            { label: 'Equity Opening', key: 'Equity_Opening', isNegative: null, unit: '¬£' },
            { label: 'Equity Drawdown', key: 'Equity_Drawdown', isNegative: false, unit: '¬£' },
            { label: 'Equity Interest', key: 'Equity_Interest', isNegative: true, unit: '¬£' },
            { label: 'Equity Repatriation', key: 'Equity_Repatriation', isNegative: true, unit: '¬£' },
            { label: 'Equity Closing', key: 'Equity_Closing', isNegative: null, bold: true, unit: '¬£' },
            { label: '', isSeparator: true },
            { label: 'Senior Loan Opening', key: 'Loan_Opening', isNegative: null, unit: '¬£' },
            { label: 'Senior Loan Drawdown', key: 'Loan_Drawdown', isNegative: false, unit: '¬£' },
            { label: 'Establishment Fee', key: 'Loan_Establishment', isNegative: true, unit: '¬£' },
            { label: 'Line Fee', key: 'Loan_Line_Fee', isNegative: true, unit: '¬£' },
            { label: 'Senior Loan Interest', key: 'Loan_Interest', isNegative: true, unit: '¬£' },
            { label: 'Senior Loan Repatriation', key: 'Loan_Repatriation', isNegative: true, unit: '¬£' },
            { label: 'Senior Loan Closing', key: 'Loan_Closing', isNegative: null, bold: true, unit: '¬£' },
            { label: '', isSeparator: true },
            { label: 'Mezzanine Opening', key: 'Mezz_Opening', isNegative: null, unit: '¬£' },
            { label: 'Mezzanine Drawdown', key: 'Mezz_Drawdown', isNegative: false, unit: '¬£' },
            { label: 'Mezz Establishment Fee', key: 'Mezz_Establishment', isNegative: true, unit: '¬£' },
            { label: 'Mezz Line Fee', key: 'Mezz_Line_Fee', isNegative: true, unit: '¬£' },
            { label: 'Mezzanine Interest', key: 'Mezz_Interest', isNegative: true, unit: '¬£' },
            { label: 'Mezzanine Repatriation', key: 'Mezz_Repatriation', isNegative: true, unit: '¬£' },
            { label: 'Mezzanine Closing', key: 'Mezz_Closing', isNegative: null, bold: true, unit: '¬£' },

            // Summary Section
            { label: 'SUMMARY', isSectionHeader: true },
            { label: 'Net Cashflow', key: 'Total_Net_Cashflow', isNegative: null, bold: true, unit: '¬£' },
            { label: 'Cumulative CF', key: 'Cumulative_Cashflow', isNegative: null, bold: true, unit: '¬£' },

            // Metrics Section
            { label: 'METRICS', isSectionHeader: true },
            { label: 'Project IRR', key: 'Project_IRR', isMetric: true, bold: true, unit: '%' },
            { label: 'Equity IRR', key: 'Equity_IRR', isMetric: true, bold: true, unit: '%' },
            { label: 'Profit', key: 'Profit', isMetric: true, bold: true, unit: '¬£' },
            { label: 'Margin on GDV', key: 'Margin', isMetric: true, bold: true, unit: '%' }
        ];

        rowCategories.forEach(category => {
            const tr = document.createElement('tr');

            // Handle section headers
            if (category.isSectionHeader) {
                tr.innerHTML = `<td class="text-start fw-bold" style="position: sticky; left: 0; background: #f8f9fa; z-index: 5; border-top: 2px solid #dee2e6; padding-top: 0.5rem; font-size: 0.75rem; color: #6c757d;">${category.label}</td>`;
                monthlyData.forEach(() => {
                    const td = document.createElement('td');
                    td.style.background = '#f8f9fa';
                    td.style.borderTop = '2px solid #dee2e6';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
                return;
            }

            // Handle separators (empty rows for visual spacing)
            if (category.isSeparator) {
                tr.innerHTML = `<td class="text-start" style="position: sticky; left: 0; background: white; z-index: 5; height: 0.5rem; padding: 0.25rem;">&nbsp;</td>`;
                monthlyData.forEach(() => {
                    const td = document.createElement('td');
                    td.style.padding = '0.25rem';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
                return;
            }

            // Row header
            const headerClass = category.bold ? 'fw-bold' : '';
            tr.innerHTML = `<td class="text-start ${headerClass}" style="position: sticky; left: 0; background: white; z-index: 5; font-size: 0.85rem;">${category.label}</td>`;

            // Handle metric rows (constant values across columns)
            if (category.isMetric) {
                let metricValue = 0;
                if (category.key === 'Project_IRR') {
                    metricValue = metrics.project_irr || 0;
                } else if (category.key === 'Equity_IRR') {
                    metricValue = metrics.equity_irr || 0;
                } else if (category.key === 'Profit') {
                    metricValue = metrics.profit || 0;
                } else if (category.key === 'Margin') {
                    metricValue = metrics.margin_on_gdv || 0;
                }

                // Handle NaN and Infinity
                if (isNaN(metricValue) || !isFinite(metricValue)) {
                    metricValue = 0;
                }

                monthlyData.forEach((row, idx) => {
                    const td = document.createElement('td');
                    td.className = 'text-end fw-bold';
                    td.style.minWidth = '90px';
                    td.style.fontSize = '0.85rem';

                    // Format based on unit
                    if (category.unit === '%') {
                        td.textContent = idx === monthlyData.length - 1 ? metricValue.toFixed(2) + '%' : '';
                    } else if (category.unit === '¬£') {
                        td.textContent = idx === monthlyData.length - 1 ? formatCurrencyValue(metricValue) : '';
                    }

                    if (metricValue < 0 && category.unit === '¬£') {
                        td.classList.add('text-danger');
                    } else if (metricValue > 0 && (category.unit === '¬£' || category.unit === '%')) {
                        td.classList.add('text-success');
                    }

                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
                return;
            }

            // Data cells for regular rows
            monthlyData.forEach(row => {
                let value = row[category.key] || 0;

                // Handle NaN and Infinity
                if (isNaN(value) || !isFinite(value)) {
                    value = 0;
                }

                let cellClass = 'text-end';

                if (category.isNegative === true) {
                    cellClass += ' text-danger';
                } else if (category.isNegative === false) {
                    cellClass += ' text-success';
                } else {
                    // Dynamic coloring based on value
                    cellClass += value < 0 ? ' text-danger' : ' text-success';
                }

                if (category.bold) {
                    cellClass += ' fw-bold';
                }

                const td = document.createElement('td');
                td.className = cellClass;
                td.style.minWidth = '90px';
                td.style.fontSize = '0.85rem';

                // Format with unit
                if (category.unit === '¬£') {
                    const formatted = Math.abs(value).toLocaleString('en-AU', {maximumFractionDigits: 0});
                    td.textContent = value < 0 ? `(${formatted})` : formatted;
                } else if (category.unit === '%') {
                    td.textContent = value.toFixed(2) + '%';
                } else {
                    td.textContent = formatCurrency(value);
                }

                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    }

    function displayCharts(charts) {
        Plotly.newPlot('cumulativeChart', charts.cumulative.data, charts.cumulative.layout, {responsive: true});
    }

    // ========== Excel-like Input Behavior ==========

    // Auto-select content when clicking on input fields
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('input[type="number"], input[type="text"], input[type="date"]');

        inputs.forEach(input => {
            // Auto-select on focus
            input.addEventListener('focus', function() {
                this.select();
            });

            // Auto-select on click
            input.addEventListener('click', function() {
                this.select();
            });

            // Keyboard navigation
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // Move to next input below (simulate Excel Enter behavior)
                    const inputs = Array.from(document.querySelectorAll('input[type="number"], input[type="text"], input[type="date"]'));
                    const currentIndex = inputs.indexOf(this);
                    if (currentIndex > -1 && currentIndex < inputs.length - 1) {
                        inputs[currentIndex + 1].focus();
                    }
                } else if (e.key === 'Tab') {
                    // Tab already moves right by default, but we'll ensure it selects
                    // Don't prevent default - let Tab work naturally
                }
            });
        });

        // Also handle selects
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
            select.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const allInputs = Array.from(document.querySelectorAll('input[type="number"], input[type="text"], input[type="date"], select'));
                    const currentIndex = allInputs.indexOf(this);
                    if (currentIndex > -1 && currentIndex < allInputs.length - 1) {
                        allInputs[currentIndex + 1].focus();
                    }
                }
            });
        });
    });
</script>
{% endblock %}
